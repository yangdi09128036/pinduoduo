import{A as e,$ as i,z as t,b as n,y as o,s,B as a,C as l,D as u,E as r,n as p,o as g,c,w as d,d as h,q as f,F as m,u as y,e as w,t as b,g as _,j as x,i as v,G as C,H as k,r as S,f as P,h as L}from"./index-DyUMtph-.js";import{_ as T}from"./uni-id-pages-agreements.BZMgDOhC.js";import{r as q}from"./uni-app.es.BWQr3qZr.js";import{_ as M}from"./uni-easyinput.DB-aqUAf.js";import{c as B,m as $}from"./store.CDKRaDHf.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{m as I}from"./login-page.mixin.BaPFTxT3.js";import"./uni-popup-dialog.BF2T52wx.js";import"./uni-popup.C65w3SNd.js";import"./uni-icons.ksb_YqOd.js";const U=R({computed:{agreements(){if(!B.agreements)return[];let{serviceUrl:e,privacyUrl:i}=B.agreements;return[{url:e,title:"用户服务协议"},{url:i,title:"隐私政策条款"}]},agree:{get(){return this.getParentComponent().agree},set(e){return this.getParentComponent().agree=e}}},data:()=>({servicesList:[{id:"username",text:"账号登录",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/user.png",path:"/uni_modules/uni-id-pages/pages/login/login-withpwd"},{id:"smsCode",text:"短信验证码",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/sms.png",path:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=smsCode"},{id:"weixin",text:"微信登录",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/weixin.png"},{id:"huawei",text:"华为登录",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/huawei.png",path:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=huawei"},{id:"huaweiMobile",text:"华为账号一键登录",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/huawei.png",path:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=huaweiMobile"},{id:"apple",text:"苹果登录",logo:"/uni_modules/uni-id-pages/static/uni-fab-login/apple.png"},{id:"univerify",text:"一键登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/univerify.png"},{id:"taobao",text:"淘宝登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/taobao.png"},{id:"facebook",text:"脸书登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/facebook.png"},{id:"alipay",text:"支付宝登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/alipay.png"},{id:"qq",text:"QQ登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/qq.png"},{id:"google",text:"谷歌登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/google.png"},{id:"douyin",text:"抖音登录",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/douyin.png"},{id:"sinaweibo",text:"新浪微博",logo:"/uni_modules/uni-id-pages/static/app/uni-fab-login/sinaweibo.png"}],univerifyStyle:{fullScreen:!0,backgroundColor:"#ffffff",buttons:{iconWidth:"45px",list:[]},privacyTerms:{defaultCheckBoxState:!1,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:"我已阅读并同意",suffix:"并使用本机号码登录",privacyItems:[]}}}),watch:{agree(e){this.univerifyStyle.privacyTerms.defaultCheckBoxState=e}},async created(){let e=this.servicesList,i=B.loginTypes;e=e.filter((e=>"apple"!=e.id&&i.includes(e.id))),i.includes("univerify")&&(this.univerifyStyle.privacyTerms.privacyItems=this.agreements,e.forEach((({id:e,logo:i,path:t})=>{"univerify"!=e&&this.univerifyStyle.buttons.list.push({iconPath:i,provider:e,path:t})}))),this.servicesList=e.filter((e=>(e.path?e.path.split("?")[0]:"")!=this.getRoute(1)))},methods:{getParentComponent(){return this.$parent.$parent},setUserInfo(e){console.log("setUserInfo",e)},getRoute(i=0){let t=e();return i>t.length?"":"/"+t[t.length-i].route},toPage(e,s=0){if(console.log("比较",this.getRoute(1),this.getRoute(2),e),this.getRoute(1)==e.split("?")[0]&&"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"==this.getRoute(1)){let t=e.split("?")[1].split("=")[1];i("uni-id-pages-setLoginType",t)}else this.getRoute(2)==e?t():this.getRoute(1)!=e?0===s?n({url:e,animationType:"slide-in-left",complete(e){}}):o({url:e,animationType:"slide-in-left",complete(e){}}):console.log("出乎意料的情况,path："+e)},async login_before(e,i=!0,n={}){var o,p;if(console.log(e,n),["qq","xiaomi","sinaweibo","taobao","facebook","google","alipay","douyin"].includes(e))return s({title:"该登录方式暂未实现，欢迎提交pr",icon:"none",duration:3e3});if(console.log("检查当前环境是否支持这种登录方式"),["univerify","apple"].includes(e))return s({title:"当前设备不支持此登录，请选择其他登录方式",icon:"none",duration:3e3});let g=((null==(p=null==(o=B)?void 0:o.agreements)?void 0:p.scope)||[]).includes("register");if("univerify"!=e&&g&&!this.agree){return this.getParentComponent().$refs.agreements.popup((()=>{this.login_before(e,i,n)}))}if("weixin"==e){const e="/";let i=location.protocol+"//"+location.host+e.replace(/\/$/,"")+(window.location.href.includes("#")?"/#":"")+"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?is_weixin_redirect=true&type=weixin";return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)?window.open(`https://open.weixin.qq.com/connect/oauth2/authorize?\n\t\t\t\t\t\t\t\t\t\tappid=${B.appid.weixin.h5}\n\t\t\t\t\t\t\t\t\t\t&redirect_uri=${encodeURIComponent(i)}\n\t\t\t\t\t\t\t\t\t\t&response_type=code\n\t\t\t\t\t\t\t\t\t\t&scope=snsapi_userinfo\n\t\t\t\t\t\t\t\t\t\t&state=STATE&connect_redirect=1#wechat_redirect`):location.href=`https://open.weixin.qq.com/connect/qrconnect?appid=${B.appid.weixin.web}\n\t\t\t\t\t\t\t\t\t\t\t&redirect_uri=${encodeURIComponent(i)}\n\t\t\t\t\t\t\t\t\t\t\t&response_type=code&scope=snsapi_login&state=STATE#wechat_redirect`}if(console.log("login ----"),a({mask:!0}),"univerify"==e){let e=function(){l(),i.close(),i.offButtonsClick(o)},i=uni.getUniverifyManager(),n=!1,o=async i=>{console.log("点击了第三方登录，provider：",i,i.provider,this.univerifyStyle.buttons.list),n=!0;let t=await uni.getCheckBoxState();this.agree=t.state;let{path:o}=this.univerifyStyle.buttons.list[i.index];o?(this.getRoute(1).includes("login-withoutpwd")&&o.includes("login-withoutpwd")&&this.getParentComponent().showCurrentWebview(),this.toPage(o,1),e()):this.agree?(e(),setTimeout((()=>{this.login_before(i.provider)}),500)):s({title:"你未同意隐私政策协议",icon:"none",duration:3e3})};return i.onButtonsClick(o),i.login({univerifyStyle:this.univerifyStyle,success:e=>{this.login(e.authResult,"univerify")},fail(e){console.log(e),n||t()},complete:async e=>{l(),i.offButtonsClick(o)}})}if("weixinMobile"===e||"huaweiMobile"===e)return this.login({phoneCode:n.phoneNumberCode},e);u({provider:e,onlyAuthorize:!0,success:async i=>{if("apple"==e){let e=await this.getUserInfo({provider:"apple"});Object.assign(i.authResult,e.userInfo),l()}this.login(["huawei","weixin"].includes(e)?{code:i.code}:i.authResult,e)},fail:async e=>{console.error(JSON.stringify(e)),r({content:`登录失败; code: ${e.errCode||-1}`,confirmText:"知道了",showCancel:!1}),l()}})},login(e,i){console.log({params:e,type:i});let t="loginBy"+i.trim().replace(i[0],i[0].toUpperCase());p.importObject("uni-id-co",{customUI:!0})[t](e).then((e=>{s({title:"登录成功",icon:"none",duration:2e3}),e.loginType=i,$.loginSuccess(e)})).catch((e=>{r({content:e.message,confirmText:"知道了",showCancel:!1})})).finally((e=>{"univerify"==i&&uni.closeAuthView(),l()}))},getUserInfo:async e=>new Promise(((i,t)=>{uni.getUserInfo({...e,success:e=>{i(e)},fail:e=>{r({content:JSON.stringify(e),showCancel:!1}),t(e)}})}))}},[["render",function(e,i,t,n,o,s){const a=_,l=x,u=v;return g(),c(u,null,{default:d((()=>[h(u,{class:"fab-login-box"},{default:d((()=>[(g(!0),f(m,null,y(o.servicesList,((e,i)=>(g(),c(u,{class:"item",key:i,onClick:i=>e.path?s.toPage(e.path):s.login_before(e.id,!1)},{default:d((()=>[h(a,{class:"logo",src:e.logo,mode:"scaleToFill"},null,8,["src"]),h(l,{class:"login-title"},{default:d((()=>[w(b(e.text),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})}],["__scopeId","data-v-b0f3b97a"]]);const j=R({mixins:[I],data:()=>({type:"",phone:"",focusPhone:!1,logo:""}),computed:{loginTypes:async()=>B.loginTypes,isPhone(){return/^1\d{10}$/.test(this.phone)},imgSrc(){return{weixin:"/uni_modules/uni-id-pages/static/login/weixin.png",apple:"/uni_modules/uni-id-pages/static/app/apple.png",huawei:"/uni_modules/uni-id-pages/static/login/huawei.png",huaweiMobile:"/uni_modules/uni-id-pages/static/login/huawei-mobile.png"}[this.type]}},async onLoad(e){let i=e.type||B.loginTypes[0];this.type=i,"univerify"!=i&&(this.focusPhone=!0),this.$nextTick((()=>{["weixin","apple","huawei","huaweiMobile"].includes(i)&&(this.$refs.uniFabLogin.servicesList=this.$refs.uniFabLogin.servicesList.filter((e=>e.id!=i)))})),C("uni-id-pages-setLoginType",(e=>{this.type=e}))},onShow(){document.onkeydown=e=>{var i=e||window.event;i&&13==i.keyCode&&this.toSmsPage()}},onUnload(){k("uni-id-pages-setLoginType")},onReady(){},methods:{showCurrentWebview(){undefined.setStyle({top:0})},showAgreementModal(){this.$refs.agreements.popup()},quickLogin(e){var i,t;let n={};console.log(e),(null==(i=e.detail)?void 0:i.code)&&(n.phoneNumberCode=e.detail.code),("weixinMobile"!==this.type&&"huaweiMobile"!==this.type||(null==(t=e.detail)?void 0:t.code))&&this.$refs.uniFabLogin.login_before(this.type,!0,n)},toSmsPage(){return this.isPhone?this.needAgreements&&!this.agree?this.$refs.agreements.popup(this.toSmsPage):void n({url:"/uni_modules/uni-id-pages/pages/login/login-smscode?phoneNumber="+this.phone}):(this.focusPhone=!0,s({title:"手机号码格式不正确",icon:"none",duration:3e3}))},toPwdLogin(){n({url:"../login/password"})},chooseArea(){s({title:"暂不支持其他国家",icon:"none",duration:3e3})}}},[["render",function(e,i,t,n,o,s){const a=_,l=v,u=x,r=L,p=q(S("uni-id-pages-agreements"),T),y=q(S("uni-easyinput"),M),b=q(S("uni-id-pages-fab-login"),U);return g(),c(l,{class:"uni-content"},{default:d((()=>[h(l,{class:"login-logo"},{default:d((()=>[h(a,{src:o.logo},null,8,["src"])])),_:1}),h(u,{class:"title"},{default:d((()=>[w("请选择登录方式")])),_:1}),["apple","weixin","weixinMobile","huawei","huaweiMobile"].includes(o.type)?(g(),f(m,{key:0},[h(u,{class:"tip"},{default:d((()=>[w("将根据第三方账号服务平台的授权范围获取你的信息")])),_:1}),h(l,{class:"quickLogin"},{default:d((()=>["weixinMobile"!==o.type&&"huaweiMobile"!==o.type?(g(),c(a,{key:0,onClick:s.quickLogin,src:s.imgSrc,mode:"widthFix",class:"quickLoginBtn"},null,8,["onClick","src"])):(g(),c(l,{key:1,style:{position:"relative"}},{default:d((()=>["weixinMobile"===o.type?(g(),c(r,{key:0,type:"primary","open-type":"getPhoneNumber",onGetphonenumber:s.quickLogin,class:"uni-btn"},{default:d((()=>[w("微信授权手机号登录")])),_:1},8,["onGetphonenumber"])):P("",!0),"huaweiMobile"===o.type?(g(),c(r,{key:1,"open-type":"getPhoneNumber",onGetphonenumber:s.quickLogin,class:"quickLoginBtn",style:{padding:"0",display:"flex"}},{default:d((()=>[h(a,{src:s.imgSrc,mode:"widthFix"},null,8,["src"])])),_:1},8,["onGetphonenumber"])):P("",!0),this.needAgreements&&!this.agree?(g(),c(l,{key:2,class:"mobile-login-agreement-layer",onClick:s.showAgreementModal},null,8,["onClick"])):P("",!0)])),_:1})),h(p,{scope:"register",ref:"agreements"},null,512)])),_:1})],64)):(g(),f(m,{key:1},[h(u,{class:"tip"},{default:d((()=>[w("未注册的账号验证通过后将自动注册")])),_:1}),h(l,{class:"phone-box"},{default:d((()=>[h(l,{onClick:s.chooseArea,class:"area"},{default:d((()=>[w("+86")])),_:1},8,["onClick"]),h(y,{trim:"both",focus:o.focusPhone,onBlur:i[0]||(i[0]=e=>o.focusPhone=!1),class:"input-box",type:"number",inputBorder:!1,modelValue:o.phone,"onUpdate:modelValue":i[1]||(i[1]=e=>o.phone=e),maxlength:"11",placeholder:"请输入手机号"},null,8,["focus","modelValue"])])),_:1}),h(p,{scope:"register",ref:"agreements"},null,512),h(r,{class:"uni-btn",type:"primary",onClick:s.toSmsPage},{default:d((()=>[w("获取验证码")])),_:1},8,["onClick"])],64)),h(b,{ref:"uniFabLogin"},null,512)])),_:1})}],["__scopeId","data-v-b3b3ca9a"]]);export{j as default};
