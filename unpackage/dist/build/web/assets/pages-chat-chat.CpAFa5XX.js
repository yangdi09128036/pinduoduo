import{a4 as s,s as e,l as t,m as i,a5 as a,a6 as o,a7 as n,c,w as l,i as h,o as r,d,q as u,u as g,F as p,e as m,t as k,x as f,f as C,g as y,j as b,S as M,I as w,h as x}from"./index-CqNzDXlw.js";import{s as I}from"./store.DvWIVlV-.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const _=F({data:()=>({userInput:"",messages:[],scrollTop:0,apiKey:"sk-22CtNLy8oqB9Kg0scqkWmpSCfd3LnT2NsxxocO2rQC5s8Qc6",apiUrl:"https://api.moonshot.cn/v1/chat/completions",showHistory:!1,userInfo:{},lastQuestion:"",chatHistory:[{title:"今天",items:[]},{title:"昨天",items:[]},{title:"7天内",items:[]},{title:"30天内",items:[]}],headerTitle:"新对话",likedMessages:{},dislikedMessages:{},feedbackMessage:"",showFeedback:!1,isVoiceEnabled:!0,voiceUrl:"",isMaleVoice:!0,voiceRoleId:1,isSpeaking:!1,currentSpeakingIndex:-1,audioContext:null,pausedMessages:{},audioCache:{}}),computed:{currentVoiceRole(){return this.isMaleVoice?"/static/role-boy.png":"/static/role-girl.png"}},mounted(){this.getUserInfo(),this.loadChatHistoryFromStorage()},methods:{getUserInfo(){I.hasLogin&&(this.userInfo=I.userInfo,console.log(this.userInfo))},toggleHistory(){this.showHistory=!this.showHistory},copyMessage(t){s({data:t,success:()=>{e({title:"复制成功",icon:"success"})}})},loadChatHistoryFromStorage(){const s=t("chatHistory");s&&(this.chatHistory=JSON.parse(s))},saveChatHistoryToStorage(){i("chatHistory",JSON.stringify(this.chatHistory))},addToHistory(s,e){const t={question:s,answer:e,timestamp:(new Date).getTime(),messages:[...this.messages]};this.chatHistory[0].items.unshift(t),this.saveChatHistoryToStorage()},loadChatHistory(s){this.messages=[...s.messages],this.showHistory=!1,this.scrollToBottom()},async sendMessage(){if(!this.userInput.trim())return;this.lastQuestion=this.userInput,this.headerTitle=this.userInput;const s={role:"user",content:this.userInput};this.messages.push(s),console.log("Messages after adding user message:",this.messages);const e=this.userInput;this.userInput="";this.messages.push({role:"assistant",content:"思考中..."}),this.$nextTick((()=>{this.scrollToBottom()}));try{const s=await a({url:this.apiUrl,method:"POST",header:{Authorization:this.apiKey,"Content-Type":"application/json"},data:{model:"moonshot-v1-8k",messages:[{role:"user",content:e}]}});if(200===s.statusCode){const t=s.data.choices[0].message.content;console.log("回答的内容:",s.data),this.messages[this.messages.length-1].content=t,this.addToHistory(e,t),this.isVoiceEnabled&&this.playVoice(t)}else this.messages[this.messages.length-1].content=`请求失败，状态码: ${s.statusCode}`}catch(t){console.error("请求失败:",t),this.messages[this.messages.length-1].content="请求失败，请稍后重试"}this.$nextTick((()=>{this.scrollToBottom()}))},scrollToBottom(){o().in(this).select(".chat-content").boundingClientRect((s=>{s&&(this.scrollTop=1e6*s.height)})).exec()},startNewChat(){this.messages=[],this.lastQuestion="",this.scrollTop=0,this.headerTitle="新对话"},retryLastQuestion(){this.lastQuestion.trim()?(this.userInput=this.lastQuestion,this.sendMessage()):console.warn("没有可重试的问题")},formatMarkdown:s=>(new MarkdownIt).render(s),likeMessage(s){this.likedMessages[s]?this.$set(this.likedMessages,s,!1):(this.dislikedMessages[s]&&this.$set(this.dislikedMessages,s,!1),this.$set(this.likedMessages,s,!0),this.feedbackMessage="感谢您的反馈，我会努力做得更好！",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),3e3))},dislikeMessage(s){this.dislikedMessages[s]?this.$set(this.dislikedMessages,s,!1):(this.likedMessages[s]&&this.$set(this.likedMessages,s,!1),this.$set(this.dislikedMessages,s,!0),this.feedbackMessage="感谢您的反馈，我会努力改正！",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),3e3))},toggleVoice(){this.isVoiceEnabled=!this.isVoiceEnabled},toggleVoiceRole(){this.isMaleVoice=!this.isMaleVoice,this.voiceRoleId=this.isMaleVoice?1:3,this.feedbackMessage=this.isMaleVoice?"已切换为男声":"已切换为女声",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)},pauseCurrentAudio(){if(this.isSpeaking&&this.audioContext&&-1!==this.currentSpeakingIndex){const s=this.currentSpeakingIndex;return this.audioContext.pause(),this.$set(this.pausedMessages,s,!0),this.feedbackMessage="已暂停之前的音频",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500),!0}return!1},async playVoice(s){this.pauseCurrentAudio();const e=`https://xiaoapi.cn/API/zs_tts.php?type=baidu&msg=${encodeURIComponent(s)}&id=${this.voiceRoleId}`;console.log("语音合成接口URL:",e);try{const s=await a({url:e,method:"GET"});if(console.log(s.data),200===s.statusCode&&200===s.data.code){this.voiceUrl=s.data.tts;const e=this.messages.length-1;this.audioCache[e]=this.voiceUrl,this.audioContext&&this.audioContext.destroy(),this.audioContext=n(),this.audioContext.src=this.voiceUrl,this.audioContext.play(),this.currentSpeakingIndex=e,this.isSpeaking=!0,this.$set(this.pausedMessages,e,!1),this.audioContext.onEnded((()=>{this.isSpeaking=!1,this.$set(this.pausedMessages,this.currentSpeakingIndex,!0),this.currentSpeakingIndex=-1}))}else console.error("语音合成失败:",s)}catch(t){console.error("语音合成请求失败:",t)}},toggleSpeech(s,e){this.isSpeaking&&this.currentSpeakingIndex===e?this.audioContext&&(this.pausedMessages[e]?(this.audioContext.play(),this.$set(this.pausedMessages,e,!1),this.feedbackMessage="继续播放"):(this.audioContext.pause(),this.$set(this.pausedMessages,e,!0),this.feedbackMessage="已暂停播放"),this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)):(this.pauseCurrentAudio(),this.synthesizeAndPlaySpeech(s,e))},async synthesizeAndPlaySpeech(s,e){if(this.audioCache[e])return void this.playFromCache(e);const t=`https://xiaoapi.cn/API/zs_tts.php?type=baidu&msg=${encodeURIComponent(s)}&id=${this.voiceRoleId}`;try{const s=await a({url:t,method:"GET"});200===s.statusCode&&200===s.data.code?(this.voiceUrl=s.data.tts,this.audioCache[e]=this.voiceUrl,this.audioContext&&this.audioContext.destroy(),this.audioContext=n(),this.audioContext.src=this.voiceUrl,this.audioContext.play(),this.isSpeaking=!0,this.currentSpeakingIndex=e,this.$set(this.pausedMessages,e,!1),this.audioContext.onEnded((()=>{this.isSpeaking=!1,this.$set(this.pausedMessages,e,!0),this.currentSpeakingIndex=-1,this.feedbackMessage="播放完成",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)})),this.feedbackMessage="正在播放语音",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)):(console.error("语音合成失败:",s),this.feedbackMessage="语音合成失败",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500))}catch(i){console.error("语音合成请求失败:",i),this.feedbackMessage="语音合成请求失败",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)}},playFromCache(s){this.audioContext&&this.audioContext.destroy(),this.audioContext=n(),this.audioContext.src=this.audioCache[s],this.audioContext.play(),this.isSpeaking=!0,this.currentSpeakingIndex=s,this.$set(this.pausedMessages,s,!1),this.audioContext.onEnded((()=>{this.isSpeaking=!1,this.$set(this.pausedMessages,s,!0),this.currentSpeakingIndex=-1,this.feedbackMessage="播放完成",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)})),this.feedbackMessage="正在播放语音",this.showFeedback=!0,setTimeout((()=>{this.showFeedback=!1}),1500)}}},[["render",function(s,e,t,i,a,o){const n=h,I=y,F=b,_=M,T=w,v=x;return r(),c(n,{class:"container"},{default:l((()=>[d(n,{class:f(["history-sidebar",{"show-sidebar":a.showHistory}])},{default:l((()=>[d(n,{class:"history-content"},{default:l((()=>[(r(!0),u(p,null,g(a.chatHistory,((s,e)=>(r(),c(n,{class:"history-section",key:e},{default:l((()=>[d(n,{class:"history-date"},{default:l((()=>[m(k(s.title),1)])),_:2},1024),(r(!0),u(p,null,g(s.items,((s,e)=>(r(),c(n,{class:"history-item",key:e,onClick:e=>o.loadChatHistory(s)},{default:l((()=>[m(k(s.question),1)])),_:2},1032,["onClick"])))),128))])),_:2},1024)))),128))])),_:1}),d(n,{class:"user-info"},{default:l((()=>[d(I,{class:"user-avatar",src:a.userInfo.avatar_file&&a.userInfo.avatar_file.url?a.userInfo.avatar_file.url:"/static/default-avatar.png",mode:"aspectFill"},null,8,["src"]),d(F,{class:"user-phone"},{default:l((()=>[m(k(a.userInfo.mobile||"173****7441"),1)])),_:1})])),_:1})])),_:1},8,["class"]),d(n,{class:f(["main-content",{"shift-content":a.showHistory}])},{default:l((()=>[d(n,{class:"header"},{default:l((()=>[d(I,{src:"/assets/more-v1VE5ohU.png",mode:"aspectFit",class:"menu-button",onClick:o.toggleHistory},null,8,["onClick"]),d(I,{src:"/assets/launch-DaV7MX8q.png",mode:"aspectFit",class:"new-chat-button",onClick:o.startNewChat},null,8,["onClick"]),d(F,{class:"header-title"},{default:l((()=>[m(k(a.headerTitle),1)])),_:1}),d(I,{src:o.currentVoiceRole,mode:"aspectFit",class:"voice-role-button",onClick:o.toggleVoiceRole},null,8,["src","onClick"]),d(I,{src:a.isVoiceEnabled?"/static/voice.png":"/static/voice-ed.png",mode:"aspectFit",class:"voice-button",onClick:o.toggleVoice},null,8,["src","onClick"])])),_:1}),d(_,{class:"chat-content","scroll-y":"true","scroll-top":a.scrollTop,"scroll-with-animation":!0},{default:l((()=>[0===a.messages.length?(r(),c(n,{key:0,class:"welcome-screen"},{default:l((()=>[d(I,{class:"welcome-logo",src:"/assets/kimi-YTVCGLCq.jpg",mode:"aspectFit"}),d(n,{class:"welcome-title"},{default:l((()=>[m("嗨！我是 Kimi")])),_:1}),d(n,{class:"welcome-subtitle"},{default:l((()=>[m(" 我可以帮你搜索、答疑、写作，请把你的任务交给我吧~ ")])),_:1})])),_:1})):(r(),c(n,{key:1,class:"messages-container"},{default:l((()=>[(r(!0),u(p,null,g(a.messages,((s,e)=>(r(),c(n,{key:e,class:f(["message-wrapper","user"===s.role?"user-message":"ai-message"])},{default:l((()=>[d(I,{class:"avatar",src:"user"===s.role?a.userInfo.avatar_file&&a.userInfo.avatar_file.url?a.userInfo.avatar_file.url:"/static/default-avatar.png":"/static/kimi.jpg",mode:"aspectFill"},null,8,["src"]),d(n,{class:"message-content"},{default:l((()=>[d(F,null,{default:l((()=>[m(k(s.content),1)])),_:2},1024),"assistant"===s.role?(r(),c(n,{key:0,class:"message-actions"},{default:l((()=>[d(I,{src:"/assets/copy-B7Ts_50S.png",mode:"aspectFit",class:"action-button",onClick:e=>o.copyMessage(s.content)},null,8,["onClick"]),d(I,{src:"/assets/refresh-D2inJRh4.png",mode:"aspectFit",onClick:o.retryLastQuestion,class:"action-button"},null,8,["onClick"]),d(I,{src:a.likedMessages[e]?"/static/thumbs-up-ed.png":"/static/thumbs-up.png",mode:"aspectFit",class:"action-button",onClick:s=>o.likeMessage(e)},null,8,["src","onClick"]),d(I,{src:a.dislikedMessages[e]?"/static/thumbs-down-ed.png":"/static/thumbs-down.png",mode:"aspectFit",class:"action-button",onClick:s=>o.dislikeMessage(e)},null,8,["src","onClick"]),d(I,{src:a.pausedMessages[e]?"/static/time-out.png":"/static/play.png",mode:"aspectFit",class:"action-button",onClick:t=>o.toggleSpeech(s.content,e)},null,8,["src","onClick"])])),_:2},1024)):C("",!0)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1})),a.showFeedback?(r(),c(n,{key:2,class:"feedback-toast"},{default:l((()=>[m(k(a.feedbackMessage),1)])),_:1})):C("",!0)])),_:1},8,["scroll-top"]),d(n,{class:"input-section"},{default:l((()=>[d(n,{class:"input-wrapper"},{default:l((()=>[d(T,{type:"text",modelValue:a.userInput,"onUpdate:modelValue":e[0]||(e[0]=s=>a.userInput=s),placeholder:"给 Kimi 发送消息","confirm-type":"send",class:"input-field",onConfirm:o.sendMessage},null,8,["modelValue","onConfirm"]),d(v,{class:f(["send-button",{"send-button-active":a.userInput.trim()}]),onClick:o.sendMessage},{default:l((()=>[m(" 发送 ")])),_:1},8,["class","onClick"])])),_:1})])),_:1})])),_:1},8,["class"])])),_:1})}],["__scopeId","data-v-0bd3ced4"]]);export{_ as default};
