import{l as a,n as t,s as e,b as s,m as o,W as n,z as c,c as l,w as r,i as d,o as i,d as u,e as m,t as p,q as h,u as f,F as y,j as _,g,h as w,x as D,f as b}from"./index-CDX771vS.js";import{s as I}from"./store.Pgya9fdc.js";import{_ as k}from"./_plugin-vue_export-helper.BCo6x5W8.js";const v=k({data:()=>({paymentData:{amount:0,username:"",avatar:"",productId:"",productName:"",productImage:"",quantity:1},selectedMethod:0,paymentMethods:[{name:"农业银行储蓄卡(0270)",icon:"/static/bank-icons/abc.png"},{name:"四川农信储蓄卡(2128)",icon:"/static/bank-icons/sc.png"},{name:"农业银行储蓄卡(0073)",icon:"/static/bank-icons/abc.png"}]}),onLoad(){console.log("用户信息:",I.userInfo);const t=a("paymentData");t&&(this.paymentData=t,console.log("支付数据",this.paymentData));const e=I.userInfo.avatar_file.url;this.paymentData.avatar=e},methods:{maskPhone:a=>a?11===a.length?a.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):a:"",selectPaymentMethod(a){this.selectedMethod=a},async handleConfirmPayment(){const c=t.database(),l=a("currentOrderIds")||[];console.log("订单ids",l);try{const a=await c.collection("wallet").where({user_id:this.paymentData.userId}).get();if(0===a.result.data.length)throw new Error("钱包不存在");const t=a.result.data[0];console.log("余额",t.balance),console.log("本次支付的总金额",this.paymentData.amount);const r=t.balance-this.paymentData.amount;if(console.log("支付后的余额",r),r<0)return e({title:"余额不足",icon:"none"}),void setTimeout((function(){s({url:"/pages/wallet/wallet"})}),1500);await c.collection("wallet").doc(t._id).update({balance:r,updated_at:Date.now()});for(const e of l)await c.collection("order").doc(e).update({paymentStatus:1,shareStatus:0});if(Array.isArray(this.paymentData.productId)&&this.paymentData.productId.length>1){const a=await Promise.all(l.map((a=>c.collection("order").doc(a).get())));console.log("最后",a);for(const t of a)if(t.result&&t.result.data){const a=t.result.data;console.log("单个商品的价格信息",a[0].amount),await c.collection("wallet_transactions").add({user_id:this.paymentData.userId,amount:a[0].amount,type:"debit",balance:r,productImage:a[0].productImage})}}else await c.collection("wallet_transactions").add({user_id:this.paymentData.userId,amount:this.paymentData.amount,type:"debit",balance:r,productImage:this.paymentData.productImage});o("paymentSuccess",!0),e({title:"支付成功",icon:"success"}),n("paymentData"),n("currentOrderIds"),setTimeout((function(){s({url:"/pages/user/order"})}),1500)}catch(r){console.error("支付失败:",r),e({title:r.message||"支付失败，请重试",icon:"none"}),setTimeout((function(){s({url:"/pages/wallet/wallet"})}),1500)}},async handleCancel(){const s=t.database(),o=a("currentOrderIds")||[];try{for(const a of o)await s.collection("order").doc(a).update({paymentStatus:0});n("paymentData"),n("currentOrderIds"),e({title:"取消支付",icon:"error"}),c()}catch(l){console.error("取消支付失败:",l),e({title:"操作失败，请重试",icon:"none"})}}}},[["render",function(a,t,e,s,o,n){const c=_,I=d,k=g,v=w;return i(),l(I,{class:"pay-container"},{default:r((()=>[u(I,{class:"pay-popup"},{default:r((()=>[u(I,{class:"close-btn",onClick:n.handleCancel},{default:r((()=>[u(c,{class:"close-icon"},{default:r((()=>[m("×")])),_:1})])),_:1},8,["onClick"]),u(I,{class:"user-info"},{default:r((()=>[u(k,{src:o.paymentData.avatar,class:"user-avatar"},null,8,["src"]),u(c,{class:"user-phone"},{default:r((()=>[m(p(n.maskPhone(o.paymentData.mobile)),1)])),_:1})])),_:1}),u(I,{class:"merchant-info"},{default:r((()=>[u(c,{class:"merchant-name"},{default:r((()=>[m("拼多多平台商户")])),_:1}),u(c,{class:"payment-amount"},{default:r((()=>[m("¥"+p(o.paymentData.amount.toFixed(2)),1)])),_:1})])),_:1}),u(I,{class:"payment-methods"},{default:r((()=>[(i(!0),h(y,null,f(o.paymentMethods,((a,t)=>(i(),l(I,{class:D(["method-item",{selected:o.selectedMethod===t}]),key:t,onClick:a=>n.selectPaymentMethod(t)},{default:r((()=>[u(k,{src:a.icon,class:"method-icon"},null,8,["src"]),u(c,{class:"method-name"},{default:r((()=>[m(p(a.name),1)])),_:2},1024),o.selectedMethod===t?(i(),l(c,{key:0,class:"method-check"},{default:r((()=>[m("✓")])),_:1})):b("",!0)])),_:2},1032,["onClick","class"])))),128))])),_:1}),u(v,{class:"confirm-btn",onClick:n.handleConfirmPayment},{default:r((()=>[m("确认付款")])),_:1},8,["onClick"]),u(I,{class:"service-provider"},{default:r((()=>[u(c,{class:"provider-text"},{default:r((()=>[m("本服务由支付宝(杭州)信息技术有限公司提供")])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-95b87f8c"]]);export{v as default};
