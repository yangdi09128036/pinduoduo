import{s as a,n as t,z as e,r as l,c as s,w as o,i as n,o as c,d as i,e as r,t as u,q as d,u as f,F as h,g as p,j as _,h as g,I as m,x as w}from"./index-CDX771vS.js";import{_ as I}from"./uni-popup.DpjIGWmU.js";import{r as b}from"./uni-app.es.i-bVV8oK.js";import{s as y}from"./store.Pgya9fdc.js";import{_ as k}from"./left.CpwphMH_.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=v({data:()=>({walletInfo:{_id:"",balance:0,user_id:""},transactions:[],rechargeAmount:"",quickAmounts:[50,100,200,500,1e3,2e3]}),computed:{userInfo:()=>y.userInfo},onLoad(){this.loadWalletInfo()},onShow(){this.loadWalletInfo()},methods:{getTransactionImage:a=>(console.log("交易记录",a),"credit"===a.type?"/static/recharge.png":"debit"===a.type&&a.productImage||"/static/wallet/payment.png"),async loadWalletInfo(){try{if(console.log("加载钱包信息",y.userInfo),!this.userInfo||!this.userInfo._id)return console.error("User info not available"),void a({title:"用户信息不可用，请先登录",icon:"none"});const e=t.database(),l=await e.collection("wallet").where({user_id:this.userInfo._id}).get();console.log("钱包查询结果",l),l&&l.result&&l.result.data&&l.result.data.length>0?(this.walletInfo=l.result.data[0],console.log("获取到钱包信息",this.walletInfo)):(console.log("未找到钱包，创建新钱包"),await this.createWallet()),await this.loadTransactions()}catch(e){console.error("加载钱包信息失败:",e),a({title:"加载钱包信息失败",icon:"none"})}},async createWallet(){try{const a=t.database(),e=await a.collection("wallet").where({user_id:this.userInfo._id}).get();if(e&&e.result&&e.result.data&&e.result.data.length>0)return this.walletInfo=e.result.data[0],void console.log("找到已存在的钱包",this.walletInfo);const l=await a.collection("wallet").add({user_id:this.userInfo._id,balance:0});if(!(l&&l.result&&l.result.id))throw new Error("创建钱包失败，未返回有效ID");this.walletInfo={_id:l.result.id,user_id:this.userInfo._id,balance:0},console.log("新钱包信息",this.walletInfo),await this.loadWalletInfo()}catch(e){console.error("创建钱包失败:",e),a({title:"创建钱包失败",icon:"none"})}},async loadTransactions(){try{const a=t.database(),e=await a.collection("wallet_transactions").where({user_id:this.userInfo._id}).orderBy("created_at","desc").limit(10).get();e&&e.result&&e.result.data?(this.transactions=e.result.data,console.log("交易记录加载成功:",this.transactions)):(console.log("没有交易记录或结构不正确",e),this.transactions=[])}catch(e){console.error("加载交易记录失败:",e),a({title:"加载交易记录失败",icon:"none"})}},async handleRecharge(){try{if(!this.walletInfo._id&&(console.log("钱包信息不完整，重新加载"),await this.loadWalletInfo(),!this.walletInfo._id))return void a({title:"钱包信息加载失败，请重试",icon:"none"});const e=parseFloat(this.rechargeAmount);if(isNaN(e)||e<=0)return void a({title:"请输入有效金额",icon:"none"});const l=("number"==typeof this.walletInfo.balance?this.walletInfo.balance:0)+e,s=t.database(),o=await s.collection("wallet").doc(this.walletInfo._id).update({balance:l,updated_at:Date.now()});if(!o||!o.result||!o.result.updated)return console.error("更新钱包余额失败",o),void a({title:"充值失败，请重试",icon:"none"});const n=await s.collection("wallet_transactions").add({user_id:this.userInfo._id,amount:e,type:"credit",balance:l});console.log("交易记录创建结果",n),this.walletInfo.balance=l,await this.loadTransactions(),a({title:"充值成功",icon:"success"}),this.hideRechargePopup()}catch(e){console.error("充值失败:",e),a({title:"充值失败，请重试",icon:"none"})}},formatBalance:a=>("number"==typeof a?a:0).toFixed(2),formatDate(a){if(!a)return"";const t=new Date(a);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},handleWithdraw(){a({title:"提现功能正在开发",icon:"none"})},showRechargePopup(){this.$refs.rechargePopup.open()},hideRechargePopup(){this.$refs.rechargePopup.close(),this.rechargeAmount=""},selectQuickAmount(a){this.rechargeAmount=a.toString()},viewAllTransactions(){a({title:"正在开发中",icon:"none"})},navBack(){e()}}},[["render",function(a,t,e,y,v,A){const C=p,S=_,x=n,W=g,P=m,$=b(l("uni-popup"),I);return c(),s(x,{class:"wallet-container"},{default:o((()=>[i(x,{class:"nav-bar"},{default:o((()=>[i(x,{class:"nav-left",onClick:A.navBack},{default:o((()=>[i(C,{src:k,mode:"",class:"nav-icon"}),i(S,{class:"nav-title"},{default:o((()=>[r("余额")])),_:1})])),_:1},8,["onClick"])])),_:1}),i(x,{class:"balance-card"},{default:o((()=>[i(x,{class:"security-tip"},{default:o((()=>[i(S,{class:"security-icon"},{default:o((()=>[r("🛡️")])),_:1}),i(S,{class:"security-text"},{default:o((()=>[r("资金安全有保障")])),_:1}),i(S,{class:"security-arrow"},{default:o((()=>[r(">")])),_:1})])),_:1}),i(x,{class:"balance-section"},{default:o((()=>[i(S,null,{default:o((()=>[r("可用余额(元)")])),_:1}),i(S,{class:"balance-amount"},{default:o((()=>[r(u(A.formatBalance(v.walletInfo.balance)),1)])),_:1})])),_:1}),i(x,{class:"action-buttons"},{default:o((()=>[i(W,{class:"action-btn withdraw",onClick:A.handleWithdraw},{default:o((()=>[r("提现")])),_:1},8,["onClick"]),i(W,{class:"action-btn recharge",onClick:A.showRechargePopup},{default:o((()=>[r("充值")])),_:1},8,["onClick"])])),_:1}),i(x,{class:"promo-banner"},{default:o((()=>[i(x,{class:"promo-icon"},{default:o((()=>[r("🔊")])),_:1}),i(S,{class:"promo-text"},{default:o((()=>[r("余额"+u(A.formatBalance(v.walletInfo.balance))+"元，每天支付享立减",1)])),_:1}),i(S,{class:"promo-link"},{default:o((()=>[r("去看看")])),_:1})])),_:1})])),_:1}),i(x,{class:"transactions"},{default:o((()=>[i(x,{class:"transactions-header"},{default:o((()=>[i(S,{class:"header-title"},{default:o((()=>[r("余额变动明细")])),_:1}),i(S,{class:"header-link",onClick:A.viewAllTransactions},{default:o((()=>[r("全部 >")])),_:1},8,["onClick"])])),_:1}),i(x,{class:"transaction-list"},{default:o((()=>[(c(!0),d(h,null,f(v.transactions,((a,t)=>(c(),s(x,{class:"transaction-item",key:t},{default:o((()=>[i(x,{class:"transaction-icon"},{default:o((()=>[i(C,{src:A.getTransactionImage(a),class:"trans-icon"},null,8,["src"])])),_:2},1024),i(x,{class:"transaction-info"},{default:o((()=>[i(S,{class:"transaction-title"},{default:o((()=>[r(u("debit"===a.type?"拼多多订单支付":"多多钱包余额充值"),1)])),_:2},1024),i(x,null,{default:o((()=>[i(S,{class:"transaction-time"},{default:o((()=>[r(u(A.formatDate(a.created_at)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),i(x,{class:"transaction-amount"},{default:o((()=>[i(S,{class:w(["amount","debit"===a.type?"debit":"credit"])},{default:o((()=>[r(u("debit"===a.type?"-":"+")+u(a.amount.toFixed(2)),1)])),_:2},1032,["class"]),i(S,{class:"balance"},{default:o((()=>[r("余额"+u(a.balance.toFixed(2))+"元",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),i($,{ref:"rechargePopup",type:"bottom"},{default:o((()=>[i(x,{class:"recharge-popup"},{default:o((()=>[i(x,{class:"popup-header"},{default:o((()=>[i(S,{class:"popup-title"},{default:o((()=>[r("充值金额")])),_:1}),i(S,{class:"popup-close",onClick:A.hideRechargePopup},{default:o((()=>[r("×")])),_:1},8,["onClick"])])),_:1}),i(x,{class:"amount-input"},{default:o((()=>[i(S,{class:"currency-symbol"},{default:o((()=>[r("¥")])),_:1}),i(P,{type:"digit",modelValue:v.rechargeAmount,"onUpdate:modelValue":t[0]||(t[0]=a=>v.rechargeAmount=a),class:"amount-field",placeholder:"请输入充值金额"},null,8,["modelValue"])])),_:1}),i(x,{class:"quick-amounts"},{default:o((()=>[(c(!0),d(h,null,f(v.quickAmounts,(a=>(c(),s(x,{class:w(["amount-option",{selected:v.rechargeAmount===a.toString()}]),key:a,onClick:t=>A.selectQuickAmount(a)},{default:o((()=>[r(" ¥"+u(a),1)])),_:2},1032,["onClick","class"])))),128))])),_:1}),i(W,{class:"confirm-recharge",onClick:A.handleRecharge,disabled:!v.rechargeAmount||parseFloat(v.rechargeAmount)<=0},{default:o((()=>[r(" 确认充值 ")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-c1434e65"]]);export{A as default};
