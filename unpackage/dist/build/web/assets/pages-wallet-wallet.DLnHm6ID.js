import{s as a,n as t,z as e,r as l,c as s,w as o,i as n,o as c,d as i,e as r,t as u,q as d,u as f,F as h,g as p,j as _,h as g,I as m,x as w}from"./index-CDX771vS.js";import{_ as I}from"./uni-popup.DpjIGWmU.js";import{r as b}from"./uni-app.es.i-bVV8oK.js";import{s as y}from"./store.Pgya9fdc.js";import{_ as k}from"./left.CpwphMH_.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=v({data:()=>({walletInfo:{_id:"",balance:0,user_id:""},transactions:[],rechargeAmount:"",quickAmounts:[50,100,200,500,1e3,2e3]}),computed:{userInfo:()=>y.userInfo},onLoad(){this.loadWalletInfo()},onShow(){this.loadWalletInfo()},methods:{getTransactionImage:a=>(console.log("äº¤æ˜“è®°å½•",a),"credit"===a.type?"/static/recharge.png":"debit"===a.type&&a.productImage||"/static/wallet/payment.png"),async loadWalletInfo(){try{if(console.log("åŠ è½½é’±åŒ…ä¿¡æ¯",y.userInfo),!this.userInfo||!this.userInfo._id)return console.error("User info not available"),void a({title:"ç”¨æˆ·ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·å…ˆç™»å½•",icon:"none"});const e=t.database(),l=await e.collection("wallet").where({user_id:this.userInfo._id}).get();console.log("é’±åŒ…æŸ¥è¯¢ç»“æœ",l),l&&l.result&&l.result.data&&l.result.data.length>0?(this.walletInfo=l.result.data[0],console.log("è·å–åˆ°é’±åŒ…ä¿¡æ¯",this.walletInfo)):(console.log("æœªæ‰¾åˆ°é’±åŒ…ï¼Œåˆ›å»ºæ–°é’±åŒ…"),await this.createWallet()),await this.loadTransactions()}catch(e){console.error("åŠ è½½é’±åŒ…ä¿¡æ¯å¤±è´¥:",e),a({title:"åŠ è½½é’±åŒ…ä¿¡æ¯å¤±è´¥",icon:"none"})}},async createWallet(){try{const a=t.database(),e=await a.collection("wallet").where({user_id:this.userInfo._id}).get();if(e&&e.result&&e.result.data&&e.result.data.length>0)return this.walletInfo=e.result.data[0],void console.log("æ‰¾åˆ°å·²å­˜åœ¨çš„é’±åŒ…",this.walletInfo);const l=await a.collection("wallet").add({user_id:this.userInfo._id,balance:0});if(!(l&&l.result&&l.result.id))throw new Error("åˆ›å»ºé’±åŒ…å¤±è´¥ï¼Œæœªè¿”å›æœ‰æ•ˆID");this.walletInfo={_id:l.result.id,user_id:this.userInfo._id,balance:0},console.log("æ–°é’±åŒ…ä¿¡æ¯",this.walletInfo),await this.loadWalletInfo()}catch(e){console.error("åˆ›å»ºé’±åŒ…å¤±è´¥:",e),a({title:"åˆ›å»ºé’±åŒ…å¤±è´¥",icon:"none"})}},async loadTransactions(){try{const a=t.database(),e=await a.collection("wallet_transactions").where({user_id:this.userInfo._id}).orderBy("created_at","desc").limit(10).get();e&&e.result&&e.result.data?(this.transactions=e.result.data,console.log("äº¤æ˜“è®°å½•åŠ è½½æˆåŠŸ:",this.transactions)):(console.log("æ²¡æœ‰äº¤æ˜“è®°å½•æˆ–ç»“æ„ä¸æ­£ç¡®",e),this.transactions=[])}catch(e){console.error("åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥:",e),a({title:"åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥",icon:"none"})}},async handleRecharge(){try{if(!this.walletInfo._id&&(console.log("é’±åŒ…ä¿¡æ¯ä¸å®Œæ•´ï¼Œé‡æ–°åŠ è½½"),await this.loadWalletInfo(),!this.walletInfo._id))return void a({title:"é’±åŒ…ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"});const e=parseFloat(this.rechargeAmount);if(isNaN(e)||e<=0)return void a({title:"è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢",icon:"none"});const l=("number"==typeof this.walletInfo.balance?this.walletInfo.balance:0)+e,s=t.database(),o=await s.collection("wallet").doc(this.walletInfo._id).update({balance:l,updated_at:Date.now()});if(!o||!o.result||!o.result.updated)return console.error("æ›´æ–°é’±åŒ…ä½™é¢å¤±è´¥",o),void a({title:"å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"});const n=await s.collection("wallet_transactions").add({user_id:this.userInfo._id,amount:e,type:"credit",balance:l});console.log("äº¤æ˜“è®°å½•åˆ›å»ºç»“æœ",n),this.walletInfo.balance=l,await this.loadTransactions(),a({title:"å……å€¼æˆåŠŸ",icon:"success"}),this.hideRechargePopup()}catch(e){console.error("å……å€¼å¤±è´¥:",e),a({title:"å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},formatBalance:a=>("number"==typeof a?a:0).toFixed(2),formatDate(a){if(!a)return"";const t=new Date(a);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},handleWithdraw(){a({title:"æç°åŠŸèƒ½æ­£åœ¨å¼€å‘",icon:"none"})},showRechargePopup(){this.$refs.rechargePopup.open()},hideRechargePopup(){this.$refs.rechargePopup.close(),this.rechargeAmount=""},selectQuickAmount(a){this.rechargeAmount=a.toString()},viewAllTransactions(){a({title:"æ­£åœ¨å¼€å‘ä¸­",icon:"none"})},navBack(){e()}}},[["render",function(a,t,e,y,v,A){const C=p,S=_,x=n,W=g,P=m,$=b(l("uni-popup"),I);return c(),s(x,{class:"wallet-container"},{default:o((()=>[i(x,{class:"nav-bar"},{default:o((()=>[i(x,{class:"nav-left",onClick:A.navBack},{default:o((()=>[i(C,{src:k,mode:"",class:"nav-icon"}),i(S,{class:"nav-title"},{default:o((()=>[r("ä½™é¢")])),_:1})])),_:1},8,["onClick"])])),_:1}),i(x,{class:"balance-card"},{default:o((()=>[i(x,{class:"security-tip"},{default:o((()=>[i(S,{class:"security-icon"},{default:o((()=>[r("ğŸ›¡ï¸")])),_:1}),i(S,{class:"security-text"},{default:o((()=>[r("èµ„é‡‘å®‰å…¨æœ‰ä¿éšœ")])),_:1}),i(S,{class:"security-arrow"},{default:o((()=>[r(">")])),_:1})])),_:1}),i(x,{class:"balance-section"},{default:o((()=>[i(S,null,{default:o((()=>[r("å¯ç”¨ä½™é¢(å…ƒ)")])),_:1}),i(S,{class:"balance-amount"},{default:o((()=>[r(u(A.formatBalance(v.walletInfo.balance)),1)])),_:1})])),_:1}),i(x,{class:"action-buttons"},{default:o((()=>[i(W,{class:"action-btn withdraw",onClick:A.handleWithdraw},{default:o((()=>[r("æç°")])),_:1},8,["onClick"]),i(W,{class:"action-btn recharge",onClick:A.showRechargePopup},{default:o((()=>[r("å……å€¼")])),_:1},8,["onClick"])])),_:1}),i(x,{class:"promo-banner"},{default:o((()=>[i(x,{class:"promo-icon"},{default:o((()=>[r("ğŸ”Š")])),_:1}),i(S,{class:"promo-text"},{default:o((()=>[r("ä½™é¢"+u(A.formatBalance(v.walletInfo.balance))+"å…ƒï¼Œæ¯å¤©æ”¯ä»˜äº«ç«‹å‡",1)])),_:1}),i(S,{class:"promo-link"},{default:o((()=>[r("å»çœ‹çœ‹")])),_:1})])),_:1})])),_:1}),i(x,{class:"transactions"},{default:o((()=>[i(x,{class:"transactions-header"},{default:o((()=>[i(S,{class:"header-title"},{default:o((()=>[r("ä½™é¢å˜åŠ¨æ˜ç»†")])),_:1}),i(S,{class:"header-link",onClick:A.viewAllTransactions},{default:o((()=>[r("å…¨éƒ¨ >")])),_:1},8,["onClick"])])),_:1}),i(x,{class:"transaction-list"},{default:o((()=>[(c(!0),d(h,null,f(v.transactions,((a,t)=>(c(),s(x,{class:"transaction-item",key:t},{default:o((()=>[i(x,{class:"transaction-icon"},{default:o((()=>[i(C,{src:A.getTransactionImage(a),class:"trans-icon"},null,8,["src"])])),_:2},1024),i(x,{class:"transaction-info"},{default:o((()=>[i(S,{class:"transaction-title"},{default:o((()=>[r(u("debit"===a.type?"æ‹¼å¤šå¤šè®¢å•æ”¯ä»˜":"å¤šå¤šé’±åŒ…ä½™é¢å……å€¼"),1)])),_:2},1024),i(x,null,{default:o((()=>[i(S,{class:"transaction-time"},{default:o((()=>[r(u(A.formatDate(a.created_at)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),i(x,{class:"transaction-amount"},{default:o((()=>[i(S,{class:w(["amount","debit"===a.type?"debit":"credit"])},{default:o((()=>[r(u("debit"===a.type?"-":"+")+u(a.amount.toFixed(2)),1)])),_:2},1032,["class"]),i(S,{class:"balance"},{default:o((()=>[r("ä½™é¢"+u(a.balance.toFixed(2))+"å…ƒ",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),i($,{ref:"rechargePopup",type:"bottom"},{default:o((()=>[i(x,{class:"recharge-popup"},{default:o((()=>[i(x,{class:"popup-header"},{default:o((()=>[i(S,{class:"popup-title"},{default:o((()=>[r("å……å€¼é‡‘é¢")])),_:1}),i(S,{class:"popup-close",onClick:A.hideRechargePopup},{default:o((()=>[r("Ã—")])),_:1},8,["onClick"])])),_:1}),i(x,{class:"amount-input"},{default:o((()=>[i(S,{class:"currency-symbol"},{default:o((()=>[r("Â¥")])),_:1}),i(P,{type:"digit",modelValue:v.rechargeAmount,"onUpdate:modelValue":t[0]||(t[0]=a=>v.rechargeAmount=a),class:"amount-field",placeholder:"è¯·è¾“å…¥å……å€¼é‡‘é¢"},null,8,["modelValue"])])),_:1}),i(x,{class:"quick-amounts"},{default:o((()=>[(c(!0),d(h,null,f(v.quickAmounts,(a=>(c(),s(x,{class:w(["amount-option",{selected:v.rechargeAmount===a.toString()}]),key:a,onClick:t=>A.selectQuickAmount(a)},{default:o((()=>[r(" Â¥"+u(a),1)])),_:2},1032,["onClick","class"])))),128))])),_:1}),i(W,{class:"confirm-recharge",onClick:A.handleRecharge,disabled:!v.rechargeAmount||parseFloat(v.rechargeAmount)<=0},{default:o((()=>[r(" ç¡®è®¤å……å€¼ ")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-c1434e65"]]);export{A as default};
