import{s as e,n as t,m as s,b as a,a as i,r as l,c as o,w as c,i as r,o as d,d as n,e as u,t as h,q as m,u as f,F as p,f as _,g,j as I,h as y,S as k,x as b}from"./index-CqNzDXlw.js";import{_ as v}from"./uni-icons.EE9020IA.js";import{r as S}from"./uni-app.es.BltvyIiY.js";import{_ as C}from"./uni-load-more.BcOHbrza.js";import{s as x}from"./store.DvWIVlV-.js";import{_ as w}from"./left.CpwphMH_.js";import{_ as j}from"./empty-box.VZfKONKX.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=D({data:()=>({historyItems:[],selectedItems:[],isAllSelected:!1,isLoading:!1,page:1,pageSize:10}),computed:{totalPrice(){return this.historyItems.filter((e=>this.selectedItems.includes(e._id))).reduce(((e,t)=>e+t.price),0).toFixed(2)},userInfo:()=>x.userInfo},onLoad(){this.loadhistoryItems()},methods:{async loadhistoryItems(){try{if(!this.userInfo||!this.userInfo._id)return void e({title:"请先登录",icon:"none"});this.isLoading=!0;const s=t.database(),a=await s.collection("history").where({userId:this.userInfo._id}).skip((this.page-1)*this.pageSize).limit(this.pageSize).get();if(0===a.result.data.length)return this.isLoading=!1,void(1===this.page&&(this.historyItems=[]));const i=a.result.data.map((e=>e.productId)),l=(await s.collection("mall-goods").where({_id:s.command.in(i)}).get()).result.data;this.historyItems=1===this.page?l:[...this.historyItems,...l],this.page++}catch(s){console.error("加载历史商品失败:",s),e({title:"加载历史商品失败",icon:"none"})}finally{this.isLoading=!1}},loadMoreItems(){this.isLoading||this.loadhistoryItems()},toggleSelect(e){const t=this.selectedItems.indexOf(e._id);-1===t?this.selectedItems.push(e._id):this.selectedItems.splice(t,1),this.isAllSelected=this.selectedItems.length===this.historyItems.length},toggleSelectAll(){this.isAllSelected?this.selectedItems=[]:this.selectedItems=this.historyItems.map((e=>e._id)),this.isAllSelected=!this.isAllSelected},async handleCheckout(){var i;if(0===this.selectedItems.length)return void e({title:"请选择商品",icon:"none"});const l=this.historyItems.filter((e=>this.selectedItems.includes(e._id))),o=parseFloat(this.totalPrice);console.log("商品总价",o);const c={amount:o,username:this.userInfo.username,mobile:this.userInfo.mobile,avatar:(null==(i=this.userInfo.avatar_file)?void 0:i.path)||"/static/avatar-default.png",userId:this.userInfo._id,productId:this.selectedItems,productName:l.map((e=>e.name)).join(", "),productImage:l[0].goods_thumb.fileID,quantity:this.selectedItems.length};s("paymentData",c);try{const e=t.database(),i=[];for(const t of this.selectedItems){const s=this.historyItems.find((e=>e._id===t));if(s){const a=await e.collection("order").add({userId:this.userInfo._id,productId:[t],productName:s.name,productImage:s.goods_thumb.fileID,amount:s.price,quantity:1,paymentStatus:0,shareStatus:0,shippingStatus:0,deliveryStatus:0,reviewStatus:0});i.push(a.result.id)}}c.orderIds=i,s("paymentData",c),s("currentOrderIds",i),a({url:"/pages/wallet/pay"})}catch(r){console.error("创建订单失败:",r),e({title:"创建订单失败，请重试",icon:"none"})}},navBack(){i({url:"/pages/user/user"})},goToProductDetail(e){a({url:`/pages/search/mall-details?id=${e}`})},async removehistoryItem(s){try{const a=t.database();await a.collection("history").where({userId:this.userInfo._id,productId:s}).remove(),this.historyItems=this.historyItems.filter((e=>e._id!==s)),this.selectedItems=this.selectedItems.filter((e=>e!==s)),e({title:"已移除历史",icon:"success"})}catch(a){console.error("移除历史失败:",a),e({title:"移除历史失败，请重试",icon:"none"})}},goShopping(){i({url:"/pages/index/index"})}}},[["render",function(e,t,s,a,i,x){const D=r,A=g,L=I,F=y,P=S(l("uni-icons"),v),z=S(l("uni-load-more"),C),q=k;return d(),o(D,{class:"container"},{default:c((()=>[n(D,{class:"status-bar"}),n(D,{class:"nav-bar"},{default:c((()=>[n(D,{class:"nav-left",onClick:x.navBack},{default:c((()=>[n(A,{src:w,class:"back-icon"})])),_:1},8,["onClick"]),n(D,{class:"nav-title"},{default:c((()=>[n(L,null,{default:c((()=>[u("我的历史")])),_:1})])),_:1}),n(D,{class:"nav-right",onClick:x.toggleSelectAll},{default:c((()=>[n(L,null,{default:c((()=>[u(h(i.isAllSelected?"取消全选":"全选"),1)])),_:1})])),_:1},8,["onClick"])])),_:1}),n(q,{"scroll-y":"true",class:"favor-list",onScrolltolower:x.loadMoreItems},{default:c((()=>[0===i.historyItems.length?(d(),o(D,{key:0,class:"empty-state"},{default:c((()=>[n(A,{src:j,class:"empty-icon"}),n(L,null,{default:c((()=>[u("暂无历史商品")])),_:1}),n(F,{class:"go-shopping-btn",onClick:x.goShopping},{default:c((()=>[u("去逛逛")])),_:1},8,["onClick"])])),_:1})):(d(!0),m(p,{key:1},f(i.historyItems,(e=>(d(),o(D,{class:"favor-item",key:e._id},{default:c((()=>[n(D,{class:"checkbox",onClick:t=>x.toggleSelect(e)},{default:c((()=>[n(D,{class:b(["checkbox-inner",{selected:i.selectedItems.includes(e._id)}])},{default:c((()=>[i.selectedItems.includes(e._id)?(d(),o(L,{key:0,class:"checkbox-icon"},{default:c((()=>[u("✓")])),_:1})):_("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"]),n(A,{src:e.goods_thumb.fileID,class:"product-image",mode:"aspectFill",onClick:t=>x.goToProductDetail(e._id)},null,8,["src","onClick"]),n(D,{class:"product-info",onClick:t=>x.goToProductDetail(e._id)},{default:c((()=>[n(D,{class:"product-name"},{default:c((()=>[u(h(e.name),1)])),_:2},1024),n(D,{class:"product-price"},{default:c((()=>[n(L,{class:"price-symbol"},{default:c((()=>[u("¥")])),_:1}),n(L,{class:"price-value"},{default:c((()=>[u(h(e.price.toFixed(2)),1)])),_:2},1024),e.original_price?(d(),o(L,{key:0,class:"original-price"},{default:c((()=>[u("¥"+h(e.original_price.toFixed(2)),1)])),_:2},1024)):_("",!0)])),_:2},1024),n(D,{class:"product-tags"},{default:c((()=>[e.is_hot?(d(),o(L,{key:0,class:"tag"},{default:c((()=>[u("热销")])),_:1})):_("",!0),e.is_new?(d(),o(L,{key:1,class:"tag"},{default:c((()=>[u("新品")])),_:1})):_("",!0),e.is_best?(d(),o(L,{key:2,class:"tag"},{default:c((()=>[u("精品")])),_:1})):_("",!0)])),_:2},1024)])),_:2},1032,["onClick"]),n(D,{class:"remove-btn",onClick:t=>x.removehistoryItem(e._id)},{default:c((()=>[n(P,{type:"trash",size:"30",color:"#999"})])),_:2},1032,["onClick"])])),_:2},1024)))),128)),i.isLoading?(d(),o(D,{key:2,class:"loading"},{default:c((()=>[n(z,{status:"loading"})])),_:1})):_("",!0)])),_:1},8,["onScrolltolower"]),i.historyItems.length>0?(d(),o(D,{key:0,class:"bottom-bar"},{default:c((()=>[n(D,{class:"total-section"},{default:c((()=>[n(L,{class:"total-label"},{default:c((()=>[u("合计：")])),_:1}),n(L,{class:"total-price"},{default:c((()=>[n(L,{class:"price-symbol"},{default:c((()=>[u("¥")])),_:1}),n(L,null,{default:c((()=>[u(h(x.totalPrice),1)])),_:1})])),_:1})])),_:1}),n(F,{class:"checkout-btn",onClick:x.handleCheckout,disabled:0===i.selectedItems.length},{default:c((()=>[u(" 去结算 ("+h(i.selectedItems.length)+") ",1)])),_:1},8,["onClick","disabled"])])),_:1})):_("",!0)])),_:1})}],["__scopeId","data-v-ad7e57c1"]]);export{A as default};
