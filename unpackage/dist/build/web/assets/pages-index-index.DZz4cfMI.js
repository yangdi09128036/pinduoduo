import{k as e,s,b as t,l as a,n as o,m as l,p as c,c as r,w as i,i as n,o as h,d,q as u,u as g,F as f,f as m,e as p,v as b,g as y,I as _,S as I,x as k,t as v,j as C}from"./index-CDX771vS.js";import{s as w}from"./store.Pgya9fdc.js";import{_ as D,a as T}from"./camera.sMgFRGYR.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const P=x({data:()=>({currentTab:0,searchPlaceholder:"请输入商品信息",categories:[],allGoods:[],currentTabData:[],placeholderProducts:[],specialItems:[{image:"/static/clock.png",text:"限时秒杀",url:"https://www.jd.com/"},{image:"/static/recharge.png",text:"话费充值",url:"https://pro.jd.com/mall/active/4NgfTXqfdYhvRcmET8SMGCrRztHU/index.html?babelChannel=ttt12&innerAnchor=100119111653"},{image:"/static/turntable.png",text:"数码国补",url:"https://pro.jd.com/mall/active/h7bbR7sFxP6thFYwDqxNWjAbh8K/index.html?babelChannel=ttt111"},{image:"/static/sale.png",text:"秒杀",url:"https://pro.jd.com/mall/active/2hZ8idqu6mj9ZGR1LbPsd3MrW2i2/index.html?babelChannel=ttt3&innerAnchor=10136238481040"},{image:"/static/money.png",text:"便宜包邮",url:"https://pro.jd.com/mall/active/3J13cRc4KPMNqXPVuVFY9aDKsBJy/index.html?babelChannel=ttt1"}],sections:[{title:"百亿补贴",image:"/static/subsidy.png",url:"/pages/subsidy/subsidy"},{title:"多多买菜",image:"/static/vegetables.png",url:"/pages/buy-vegetables/buy-vegetables"}],pageNumber:1,pageSize:100,scrollHeight:"calc(100vh - 240rpx)",isRefreshing:!1,cacheKey:"homePageData",cacheExpiration:3e8,userInfoChecked:!1,userInfoComplete:!1,isDataLoaded:!1}),async onLoad(){e({success:e=>{this.scrollHeight=`calc(100vh - ${e.statusBarHeight}px - 240rpx)`}}),await this.checkUserInfoSync(),await this.getInitialData()},onShow(){this.userInfoChecked&&!this.userInfoComplete&&this.checkUserInfo(!0)},methods:{async checkUserInfoSync(){if(console.log("开始同步检查用户信息"),!w.hasLogin)return console.log("用户未登录，跳过信息检查"),void(this.userInfoChecked=!0);let e=0;for(;!w.userInfo&&e<20;)console.log(`等待用户信息加载，尝试 ${e+1}/20`),await new Promise((e=>setTimeout(e,2e3))),e++;if(this.userInfoChecked=!0,!w.userInfo)return console.log("用户信息加载超时或不存在"),void(this.userInfoComplete=!1);console.log("检查用户信息:",w.userInfo);const a=!!w.userInfo.mobile&&""!==w.userInfo.mobile.trim(),o=!!w.userInfo.address&&""!==w.userInfo.address.trim();console.log("用户信息检查结果:",{hasMobile:a,hasAddress:o}),this.userInfoComplete=a&&o,this.userInfoComplete?console.log("用户信息已完整"):(console.log("用户信息不完整，需要补充"),s({title:"请完善手机与收货地址",icon:"none",duration:2e3}),setTimeout((()=>{t({url:"/pages/user/set"})}),2e3))},checkUserInfo(e=!1){if(!w.hasLogin)return void console.log("用户未登录，跳过信息检查");const a=w.userInfo;if(!a)return void console.log("用户信息不存在，跳过信息检查");console.log("检查用户信息:",JSON.stringify(a));const o=!!a.mobile&&""!==a.mobile.trim(),l=!!a.address&&""!==a.address.trim();return console.log("用户信息检查结果:",{hasMobile:o,hasAddress:l}),this.userInfoComplete=o&&l,this.userInfoComplete?(console.log("用户信息已完整"),!0):(console.log("用户信息不完整，需要补充"),e||(s({title:"请完善手机与收货地址",icon:"none",duration:2e3}),setTimeout((()=>{t({url:"/pages/user/set"})}),2e3)),!1)},async getInitialData(){try{const e=this.getCachedData();e?this.setPageData(e):await this.fetchAndCacheData(),this.switchTab(0),this.isDataLoaded=!0}catch(e){throw console.error("初始化数据失败:",e),this.isDataLoaded=!1,e}},getCachedData(){const e=a(this.cacheKey);return e&&Date.now()-e.timestamp<this.cacheExpiration?e.data:null},async fetchAndCacheData(){try{const{result:e}=await o.callFunction({name:"getHomePageData",data:{pageNumber:this.pageNumber,pageSize:this.pageSize}});if(!e.success)throw new Error(e.error);this.setPageData(e.data),this.cacheData(e.data)}catch(e){throw console.error("获取数据失败:",e),e}},setPageData(e){this.categories=e.categories||[],this.allGoods=e.goods||[],this.allGoods.length>0&&(this.searchPlaceholder=this.allGoods[Math.floor(Math.random()*this.allGoods.length)].keywords||"请输入商品信息")},cacheData(e){l(this.cacheKey,{timestamp:Date.now(),data:e})},switchTab(e){this.currentTab=e;const s=this.categories[e];if(s)if(0===e){const e=[...this.allGoods].sort((()=>Math.random()-.5));this.currentTabData=e.slice(0,this.pageSize),this.placeholderProducts=e.slice(this.pageSize-80,this.pageSize+5)}else this.currentTabData=this.allGoods.filter((e=>parseInt(e.category_id)===parseInt(s.sort)))},navigateToSearch(){t({url:"/pages/search/search"})},navigateToPage(e){try{window.location.href=e}catch(s){console.error("跳转失败:",s)}},navigateToSection(e){const s=this.sections[e];s&&t({url:s.url})},navigateToProduct(e){e&&(c({key:"currentProduct",data:e,success:()=>{console.log("商品信息存储成功",e)}}),t({url:"../search/mall-details"}))},onRefresh(){console.log("正在刷新..."),this.isRefreshing=!0,this.fetchAndCacheData().then((()=>{this.switchTab(this.currentTab),this.isRefreshing=!1})).catch((e=>{console.error("刷新失败:",e),this.isRefreshing=!1}))}}},[["render",function(e,s,t,a,o,l){const c=y,w=_,x=n,P=C,S=I;return h(),r(x,{class:"container"},{default:i((()=>[d(x,{class:"fixed-head"},{default:i((()=>[d(x,{class:"search-container"},{default:i((()=>[d(x,{class:"search-box",onClick:l.navigateToSearch},{default:i((()=>[d(c,{class:"search-icon",src:D,mode:"aspectFit"}),d(w,{class:"search-input",type:"text",placeholder:o.searchPlaceholder},null,8,["placeholder"]),d(c,{class:"search-icon",src:T,mode:"aspectFit"})])),_:1},8,["onClick"])])),_:1}),d(x,{class:"tab-container"},{default:i((()=>[(h(!0),u(f,null,g(o.categories,((e,s)=>(h(),r(x,{key:s,class:k(["tab-item",{active:o.currentTab===s}]),onClick:e=>l.switchTab(s)},{default:i((()=>[p(v(e.name),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),d(S,{"scroll-y":"",class:"scroll-container",style:b({height:o.scrollHeight}),onRefresherrefresh:l.onRefresh,"refresher-enabled":"true","refresher-threshold":100,"refresher-default-style":"none","refresher-background":"#eee","lower-threshold":"0","refresher-triggered":o.isRefreshing},{default:i((()=>[0===o.currentTab?(h(),u(f,{key:0},[d(x,{class:"section-new"},{default:i((()=>[(h(!0),u(f,null,g(o.specialItems,((e,s)=>(h(),r(x,{key:s,class:"common-item",onClick:s=>l.navigateToPage(e.url)},{default:i((()=>[d(c,{class:"section-image",src:e.image,mode:"aspectFit","lazy-load":!0},null,8,["src"]),d(P,{class:"section-text"},{default:i((()=>[p(v(e.text),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),(h(!0),u(f,null,g(o.sections,((e,s)=>(h(),r(x,{key:s,class:"section",onClick:e=>l.navigateToSection(s)},{default:i((()=>[d(x,{class:"common-item"},{default:i((()=>[d(c,{class:"section-image",src:e.image,mode:"aspectFit","lazy-load":!0},null,8,["src"]),d(P,{class:"section-text-new"},{default:i((()=>[p(v(e.title),1)])),_:2},1024)])),_:2},1024),(h(!0),u(f,null,g(o.placeholderProducts.slice(4*s,4*(s+1)),((e,s)=>(h(),r(x,{key:s,class:"common-item"},{default:i((()=>{var s;return[d(c,{class:"section-image",src:null==(s=e.goods_thumb)?void 0:s.fileID,mode:"aspectFit","lazy-load":!0},null,8,["src"]),d(P,{class:"price",style:{color:"red"}},{default:i((()=>[p("¥"+v(e.price),1)])),_:2},1024)]})),_:2},1024)))),128))])),_:2},1032,["onClick"])))),128))],64)):m("",!0),d(x,{class:"content"},{default:i((()=>[null!==o.currentTab?(h(),r(x,{key:0,class:"tab-content"},{default:i((()=>[(h(!0),u(f,null,g(o.currentTabData,((e,s)=>(h(),r(x,{key:s,class:"content-item",onClick:s=>l.navigateToProduct(e)},{default:i((()=>[d(x,{class:"product-card"},{default:i((()=>{var s;return[d(c,{class:"item-image",src:null==(s=e.goods_thumb)?void 0:s.fileID,mode:"aspectFit","lazy-load":!0},null,8,["src"]),d(x,{class:"product-info"},{default:i((()=>[d(P,{class:"item-title"},{default:i((()=>[p(v(e.name),1)])),_:2},1024),d(x,{class:"service-tags"},{default:i((()=>[d(P,{class:"tag pay-later"},{default:i((()=>[p("先用后付")])),_:1}),d(P,{class:"tag quick-refund"},{default:i((()=>[p("极速退款")])),_:1})])),_:1}),d(x,{class:"price-row"},{default:i((()=>[d(P,{class:"price"},{default:i((()=>[p("¥"+v(e.price),1)])),_:2},1024),d(P,{class:"sales"},{default:i((()=>[p("全店已拼"+v(e.total_sell_count)+"+件",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)]})),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(h(),r(x,{key:1,class:"loading"},{default:i((()=>[p("加载中...")])),_:1}))])),_:1})])),_:1},8,["style","onRefresherrefresh","refresher-triggered"])])),_:1})}],["__scopeId","data-v-d87bc6f2"]]);export{P as default};
