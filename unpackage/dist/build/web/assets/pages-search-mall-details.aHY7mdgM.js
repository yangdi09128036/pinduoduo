import{l as s,W as o,s as a,n as e,m as t,b as l,z as i,r as n,c,w as r,i as d,o as u,d as f,e as g,q as _,u as p,F as h,t as I,f as y,x as m,j as k,g as v,ae as b,h as w,af as F}from"./index-El_S5awX.js";import{_ as C}from"./uni-icons.Bmz5z2vR.js";import{r as q}from"./uni-app.es.DUfiIcRS.js";import{s as P}from"./store.D9vwEKqx.js";import{_ as M}from"./left.CpwphMH_.js";import{_ as S,a as x}from"./wallet-red.Cfw-DLU5.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=B({data:()=>({goodsInfo:null,isLoading:!0,showBuyPopup:!1,quantity:1,isFavorite:!1,successMessage:"",errorMessage:""}),async onLoad(s){await this.loadGoodsInfo(s),await this.checkFavoriteStatus(),console.log("Initial userInfo:",P.userInfo),await this.addToHistory()},onShow(){s("paymentSuccess")&&(o("paymentSuccess"),a({title:"æ”¯ä»˜æˆåŠŸ",icon:"success"}),this.hidePopup())},computed:{userInfo:()=>P.userInfo},methods:{async loadGoodsInfo(o){this.isLoading=!0;try{if(o&&o.id){const s=e.database(),a=await s.collection("mall-goods").doc(o.id).get();a.result.data&&a.result.data.length>0&&(this.goodsInfo=a.result.data[0])}else{const o=s("currentProduct");o&&(this.goodsInfo=o)}console.log("å•†å“è¯¦æƒ…é¡µæ•°æ®",this.goodsInfo)}catch(a){console.error("è·å–å•†å“ä¿¡æ¯å¤±è´¥:",a)}finally{this.isLoading=!1}},async checkFavoriteStatus(){if(!P.userInfo||!this.goodsInfo)return;console.log("ç”¨æˆ·id",P.userInfo._id),console.log("å•†å“id",this.goodsInfo._id);const s=e.database().collection("favor"),o=await s.where({userId:P.userInfo._id,productId:this.goodsInfo._id}).get();this.isFavorite=o.result.data.length>0},async addToHistory(){if(!this.goodsInfo||!P.userInfo)return void console.warn("å•†å“ä¿¡æ¯æˆ–ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºï¼Œæ— æ³•è®°å½•åˆ°å†å²æµè§ˆ");const s=e.database().collection("history");try{0===(await s.where({userId:P.userInfo._id,productId:this.goodsInfo._id}).get()).result.data.length?(await s.add({userId:P.userInfo._id,productId:this.goodsInfo._id}),console.log("å•†å“å·²è®°å½•åˆ°å†å²æµè§ˆ")):console.log("å•†å“å·²å­˜åœ¨äºå†å²æµè§ˆä¸­")}catch(o){console.error("è®°å½•å•†å“åˆ°å†å²æµè§ˆå¤±è´¥",o)}},async toggleFavorite(){P.userInfo&&this.goodsInfo?(this.isFavorite?await this.removeFromFavorites():await this.addToFavorites(),this.isFavorite=!this.isFavorite):a({title:"è¯·å…ˆç™»å½•",icon:"none"})},async addToFavorites(){const s=e.database().collection("favor");try{await s.add({userId:P.userInfo._id,productId:this.goodsInfo._id}),this.successMessage="æ”¶è—æˆåŠŸ",this.errorMessage="",a({title:this.successMessage,icon:"success"})}catch(o){this.errorMessage=o.message||"æ”¶è—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",this.successMessage="",a({title:this.errorMessage,icon:"none"})}},async removeFromFavorites(){const s=e.database().collection("favor");try{await s.where({userId:P.userInfo._id,productId:this.goodsInfo._id}).remove(),this.successMessage="å–æ¶ˆæ”¶è—æˆåŠŸ",this.errorMessage="",a({title:this.successMessage,icon:"success"})}catch(o){this.errorMessage=o.message||"å–æ¶ˆæ”¶è—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",this.successMessage="",a({title:this.errorMessage,icon:"none"})}},maskPhone:s=>s?s.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"",showPopup(){this.showBuyPopup=!0},hidePopup(){this.showBuyPopup=!1},increaseQuantity(){this.quantity++},decreaseQuantity(){this.quantity>1&&this.quantity--},async handlePayment(){if(!this.userInfo)return void a({title:"è¯·å…ˆç™»å½•",icon:"none"});const s={amount:(this.goodsInfo.group_price||this.goodsInfo.price)*this.quantity,username:this.userInfo.username,mobile:this.userInfo.mobile,avatar:this.userInfo.avatar_file.url||"/static/avatar-default.png",productId:this.goodsInfo._id,productName:this.goodsInfo.name,productImage:this.goodsInfo.goods_thumb.fileID,quantity:this.quantity,userId:this.userInfo._id};console.log("æ”¯ä»˜æ•°æ®",s),t("paymentData",s);const o=e.database().collection("order");try{const e=await o.add({userId:this.userInfo._id,productId:[this.goodsInfo._id],productName:this.goodsInfo.name,productImage:this.goodsInfo.goods_thumb.fileID,quantity:this.quantity,amount:s.amount,paymentStatus:0,shareStatus:0,shippingStatus:0,deliveryStatus:0,reviewStatus:0});console.log("orderResult",e),e&&e.result&&e.result.id?(t("currentOrderIds",[e.result.id]),console.log("orderResult.id",e.result.id),l({url:"/pages/wallet/pay"})):(console.error("è®¢å•åˆ›å»ºæˆåŠŸï¼Œä½†æœªè¿”å›æœ‰æ•ˆçš„ orderResult"),a({title:"åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"}))}catch(i){console.error("åˆ›å»ºè®¢å•å¤±è´¥:",i),a({title:"åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},convertToBannerArray:s=>"object"!=typeof s||null===s||Array.isArray(s)?s||[]:[s],navBack(){i()},goSet(){l({url:"/pages/user/set"})}}},[["render",function(s,o,a,e,t,l){const i=k,P=d,B=v,j=F,T=b,A=w,D=q(n("uni-icons"),C);return u(),c(P,{class:"container"},{default:r((()=>[t.isLoading?(u(),c(P,{key:0,class:"loading"},{default:r((()=>[f(i,null,{default:r((()=>[g("å•†å“ä¿¡æ¯åŠ è½½ä¸­...")])),_:1})])),_:1})):t.goodsInfo?(u(),c(P,{key:1},{default:r((()=>[f(P,{class:"back-icon-container"},{default:r((()=>[f(B,{class:"back-icon",src:M,onClick:l.navBack},null,8,["onClick"])])),_:1}),f(T,{class:"banner",circular:"","indicator-dots":!0,autoplay:!0,interval:"3000",duration:"1000"},{default:r((()=>[(u(!0),_(h,null,p(l.convertToBannerArray(t.goodsInfo.goods_banner_imgs),((s,o)=>(u(),c(j,{key:o},{default:r((()=>[f(B,{src:s.url,mode:"aspectFill",class:"banner-image"},null,8,["src"])])),_:2},1024)))),128))])),_:1}),f(P,{class:"price-marketing"},{default:r((()=>[f(P,{class:"price-section"},{default:r((()=>[f(i,{class:"currency"},{default:r((()=>[g("Â¥")])),_:1}),f(i,{class:"price"},{default:r((()=>[g(I(t.goodsInfo.price),1)])),_:1}),t.goodsInfo.is_on_sale?(u(),c(i,{key:0,class:"original-price"},{default:r((()=>[g("Â¥"+I((1.2*t.goodsInfo.price).toFixed(2)),1)])),_:1})):y("",!0)])),_:1}),f(P,{class:"promotion-tags"},{default:r((()=>[f(i,{class:"promotion-tag"},{default:r((()=>[g("30å¤©ä½ä»·")])),_:1}),f(i,{class:"promotion-text"},{default:r((()=>[g("å…¨ç½‘ä½ä»·")])),_:1})])),_:1})])),_:1}),f(P,{class:"goods-info"},{default:r((()=>[f(P,{class:"title-section"},{default:r((()=>[f(i,{class:"brand-tag"},{default:r((()=>[g("å“ç‰Œ")])),_:1}),f(i,{class:"title"},{default:r((()=>[g(I(t.goodsInfo.name),1)])),_:1})])),_:1}),f(P,{class:"sales-stats"},{default:r((()=>[f(i,{class:"stat-item"},{default:r((()=>[g(I(t.goodsInfo.total_sell_count||"2068")+"äººå¥½è¯„",1)])),_:1}),f(i,{class:"stat-divider"},{default:r((()=>[g("|")])),_:1}),f(i,{class:"stat-item"},{default:r((()=>[g("24å°æ—¶å†…200+äººæ‹¼å•")])),_:1}),f(i,{class:"stat-divider"},{default:r((()=>[g("|")])),_:1}),f(i,{class:"stat-item"},{default:r((()=>[g("3466äººæ”¶è—")])),_:1})])),_:1}),t.goodsInfo.is_hot||t.goodsInfo.is_new||t.goodsInfo.is_best?(u(),c(P,{key:0,class:"tags"},{default:r((()=>[t.goodsInfo.is_hot?(u(),c(i,{key:0,class:"tag"},{default:r((()=>[g("çƒ­é”€")])),_:1})):y("",!0),t.goodsInfo.is_new?(u(),c(i,{key:1,class:"tag"},{default:r((()=>[g("æ–°å“")])),_:1})):y("",!0),t.goodsInfo.is_best?(u(),c(i,{key:2,class:"tag"},{default:r((()=>[g("ç²¾å“")])),_:1})):y("",!0)])),_:1})):y("",!0),f(P,{class:"image-gallery"},{default:r((()=>[(u(!0),_(h,null,p(l.convertToBannerArray(t.goodsInfo.goods_banner_imgs),((s,o)=>(u(),c(P,{class:"image-item",key:o},{default:r((()=>[f(B,{src:s.url,mode:"aspectFill",class:"gallery-image"},null,8,["src"])])),_:2},1024)))),128))])),_:1})])),_:1}),f(P,{class:"bottom-bar"},{default:r((()=>[f(P,{class:"action-buttons"},{default:r((()=>[f(P,{class:"action-item"},{default:r((()=>[f(i,{class:"action-icon"},{default:r((()=>[g("ğŸª")])),_:1}),f(i,{class:"action-text"},{default:r((()=>[g("åº—é“º")])),_:1})])),_:1}),f(P,{class:"action-item",onClick:l.toggleFavorite},{default:r((()=>[f(i,{class:"action-icon"},{default:r((()=>[g(I(t.isFavorite?"â¤ï¸":"ğŸ¤"),1)])),_:1}),f(i,{class:"action-text"},{default:r((()=>[g("æ”¶è—")])),_:1})])),_:1},8,["onClick"]),f(P,{class:"action-item"},{default:r((()=>[f(i,{class:"action-icon"},{default:r((()=>[g("â˜ï¸")])),_:1}),f(i,{class:"action-text"},{default:r((()=>[g("å®¢æœ")])),_:1})])),_:1})])),_:1}),f(P,{class:"buy-button"},{default:r((()=>[f(A,{class:"group-buy",onClick:l.showPopup},{default:r((()=>[g("å‘èµ·æ‹¼å•")])),_:1},8,["onClick"])])),_:1})])),_:1}),t.showBuyPopup?(u(),c(P,{key:0,class:"popup-mask",onClick:l.hidePopup},null,8,["onClick"])):y("",!0),f(P,{class:m(["popup-content",{"popup-show":t.showBuyPopup}])},{default:r((()=>[f(P,{class:"close-btn",onClick:l.hidePopup},{default:r((()=>[g("Ã—")])),_:1},8,["onClick"]),f(P,{class:"delivery-info"},{default:r((()=>[f(P,{class:"shipping-policy"},{default:r((()=>[f(D,{type:"checkbox-filled",color:"#67c23a",size:"16"}),f(i,{class:"policy-text"},{default:r((()=>[g("å…¨åœºåŒ…é‚® Â· ä¸ƒå¤©é€€æ¢ Â· 48å°æ—¶å‘è´§")])),_:1})])),_:1}),l.userInfo?(u(),c(P,{key:0,class:"address-info",onClick:l.goSet},{default:r((()=>[f(P,{class:"address-detail"},{default:r((()=>[f(B,{src:S,class:"address-icon"}),f(i,{class:"user-name"},{default:r((()=>[g(I(l.userInfo.username)+", ",1)])),_:1}),f(i,{class:"user-phone"},{default:r((()=>[g(I(l.maskPhone(l.userInfo.mobile))+", ",1)])),_:1}),f(i,{class:"user-address"},{default:r((()=>[g(I(l.userInfo.address),1)])),_:1})])),_:1}),f(D,{type:"right",size:"30",color:"#999"})])),_:1},8,["onClick"])):y("",!0)])),_:1}),f(P,{class:"product-info"},{default:r((()=>[f(B,{src:t.goodsInfo.goods_thumb.fileID,class:"product-image"},null,8,["src"]),f(P,{class:"product-details"},{default:r((()=>[f(P,{class:"group-price"},{default:r((()=>[f(i,{class:"price-label"},{default:r((()=>[g("å¤šäººå›¢ä»·")])),_:1}),f(i,{class:"price-symbol"},{default:r((()=>[g("Â¥")])),_:1}),f(i,{class:"price-value"},{default:r((()=>[g(I(t.goodsInfo.group_price||t.goodsInfo.price),1)])),_:1})])),_:1}),f(P,{class:"selected-info"},{default:r((()=>[f(i,null,{default:r((()=>[g("å·²é€‰ï¼š"+I(t.goodsInfo.name),1)])),_:1})])),_:1})])),_:1})])),_:1}),f(P,{class:"quantity-selector"},{default:r((()=>[f(i,null,{default:r((()=>[g("æ•°é‡")])),_:1}),f(P,{class:"quantity-controls"},{default:r((()=>[f(A,{class:"qty-btn",onClick:l.decreaseQuantity},{default:r((()=>[g("-")])),_:1},8,["onClick"]),f(i,{class:"qty-value"},{default:r((()=>[g(I(t.quantity),1)])),_:1}),f(A,{class:"qty-btn",onClick:l.increaseQuantity},{default:r((()=>[g("+")])),_:1},8,["onClick"])])),_:1})])),_:1}),f(P,{class:"payment-method-section"},{default:r((()=>[f(i,null,{default:r((()=>[g("ä½¿ç”¨")])),_:1}),f(B,{src:x,class:"wallet-icon"}),f(i,null,{default:r((()=>[g("å¤šå¤šé’±åŒ…æ”¯ä»˜")])),_:1})])),_:1}),f(P,{class:"payment-section"},{default:r((()=>[f(A,{class:"payment-btn",onClick:l.handlePayment},{default:r((()=>[g(" ç«‹å³æ”¯ä»˜ Â¥"+I((t.goodsInfo.group_price||t.goodsInfo.price)*t.quantity),1)])),_:1},8,["onClick"])])),_:1})])),_:1},8,["class"])])),_:1})):(u(),c(P,{key:2,class:"error"},{default:r((()=>[f(i,null,{default:r((()=>[g("åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•")])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-0cf3952f"]]);export{j as default};
