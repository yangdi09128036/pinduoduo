import{n as a,s as e,z as s,E as l,b as t,B as o,C as i,a5 as n,r as c,c as r,w as d,i as u,o as m,d as f,e as p,f as h,t as _,g as b,j as I,I as g,ab as y,h as v,ad as k}from"./index-CDX771vS.js";import{_ as w}from"./uni-id-pages-avatar.CBt3RajW.js";import{r as U}from"./uni-app.es.i-bVV8oK.js";import{s as x}from"./store.Pgya9fdc.js";import{_ as V}from"./left.CpwphMH_.js";import{_ as j}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.D1MAE8uI.js";const F=j({data:()=>({username:"",mobile:"",address:"",locationInfo:null,mapUrl:"",key:"21bbea8854ce73ebd9163d7cf6cc9c76"}),onLoad(){this.loadUserInfo(),this.getLocationByIP()},methods:{async loadUserInfo(){try{const e=await a.callFunction({name:"uni-id-cf",data:{action:"getCurrentUserInfo",params:{uid:x.userInfo._id,field:["username","mobile","address"]}}});if(0!==e.result.code)throw new Error(e.result.message||"获取用户信息失败");{const a=e.result.userInfo;this.username=a.username||"",this.mobile=a.mobile||"",this.address=a.address||"",x.userInfo={...x.userInfo,...a}}}catch(s){console.error("获取用户信息失败:",s);const a=x.userInfo||{};this.username=a.username||"",this.mobile=a.mobile||"",this.address=a.address||"",e({title:"获取信息失败，使用缓存数据",icon:"none"})}},async saveUserInfo(){if(this.username&&this.mobile&&this.address)try{const l=a.database();await l.collection("uni-id-users").doc(x.userInfo._id).update({username:this.username,mobile:this.mobile,address:this.address}),x.userInfo={...x.userInfo,username:this.username,mobile:this.mobile,address:this.address},console.log("之后用户信息",x.userInfo),e({title:"保存成功",icon:"success"}),setTimeout((()=>{s()}),1500)}catch(l){console.error("保存用户信息失败:",l),e({title:"保存失败，请重试",icon:"none"})}else e({title:"请填写完整信息",icon:"none"})},handleBack(){s()},handleLogout(){l({title:"提示",content:"确定要退出登录吗？",success:a=>{a.confirm&&t({url:"/uni_modules/uni-id-pages/pages/login/login-withpwd"})}})},async getLocationByIP(){o({title:"定位中..."});try{const a=await this.getIPLocation();console.log("定位信息:",a),this.locationInfo=a.data;let e=0,s=0;if(a.data.rectangle){const l=a.data.rectangle.split(";");if(l.length>0){const a=l[0].split(",");e=parseFloat(a[0]).toFixed(5),s=parseFloat(a[1]).toFixed(5);let t=parseFloat(e)+.43914,o=parseFloat(s)+.15293;this.mapUrl=`https://restapi.amap.com/v3/staticmap?location=${t},${o}&zoom=14&size=600*300&markers=mid,,A:${t},${o}&key=${this.key}`}}}catch(a){console.error("定位失败:",a),this.locationInfo=null,e({title:"定位失败",icon:"none"})}finally{i()}},getIPLocation(){return new Promise(((a,e)=>{n({url:`https://restapi.amap.com/v3/ip?key=${this.key}`,success:s=>{"1"===s.data.status?a(s):e(new Error(s.data.info||"定位失败"))},fail:a=>{e(a)}})}))}}},[["render",function(a,e,s,l,t,o){const i=b,n=u,x=I,j=U(c("uni-id-pages-avatar"),w),F=g,P=y,L=v,C=k;return m(),r(n,{class:"container"},{default:d((()=>[f(n,{class:"nav-bar"},{default:d((()=>[f(n,{class:"nav-back",onClick:o.handleBack},{default:d((()=>[f(i,{src:V,mode:"",class:"back-icon"})])),_:1},8,["onClick"]),f(x,{class:"page-title"},{default:d((()=>[p("个人信息")])),_:1})])),_:1}),f(C,{onSubmit:o.saveUserInfo},{default:d((()=>[f(n,{class:"form-card"},{default:d((()=>[f(n,{class:"form-item avatar-item"},{default:d((()=>[f(x,{class:"label"},{default:d((()=>[p("头像")])),_:1}),f(n,{class:"avatar-wrapper"},{default:d((()=>[f(j,{width:"120rpx",height:"120rpx"})])),_:1})])),_:1}),f(n,{class:"divider"}),f(n,{class:"form-item"},{default:d((()=>[f(x,{class:"label"},{default:d((()=>[p("用户名")])),_:1}),f(F,{class:"input",type:"text",modelValue:t.username,"onUpdate:modelValue":e[0]||(e[0]=a=>t.username=a),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),f(n,{class:"divider"}),f(n,{class:"form-item"},{default:d((()=>[f(x,{class:"label"},{default:d((()=>[p("手机号码")])),_:1}),f(F,{class:"input",type:"number",modelValue:t.mobile,"onUpdate:modelValue":e[1]||(e[1]=a=>t.mobile=a),placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),f(n,{class:"divider"}),f(n,{class:"form-item address-item"},{default:d((()=>[f(x,{class:"label"},{default:d((()=>[p("收货地址")])),_:1}),f(P,{class:"textarea",modelValue:t.address,"onUpdate:modelValue":e[2]||(e[2]=a=>t.address=a),placeholder:"请输入详细收货地址"},null,8,["modelValue"])])),_:1})])),_:1}),t.locationInfo?(m(),r(n,{key:0,class:"section-title"},{default:d((()=>[f(n,{class:"title-line"}),f(x,null,{default:d((()=>[p("位置信息")])),_:1}),f(n,{class:"title-line"})])),_:1})):h("",!0),t.locationInfo?(m(),r(n,{key:1,class:"map-card"},{default:d((()=>[t.mapUrl?(m(),r(i,{key:0,src:t.mapUrl,mode:"widthFix",class:"map-image"},null,8,["src"])):(m(),r(n,{key:1,class:"map-placeholder"},{default:d((()=>[f(x,{class:"placeholder-text"},{default:d((()=>[p("地图加载中...")])),_:1})])),_:1}))])),_:1})):h("",!0),t.locationInfo?(m(),r(n,{key:2,class:"location-info-card"},{default:d((()=>[f(n,{class:"location-header"},{default:d((()=>[f(x,{class:"location-title"},{default:d((()=>[p("您的大概位置")])),_:1})])),_:1}),f(n,{class:"location-detail"},{default:d((()=>[f(n,{class:"location-item"},{default:d((()=>[f(x,{class:"location-label"},{default:d((()=>[p("省份:")])),_:1}),f(x,{class:"location-value"},{default:d((()=>[p(_(t.locationInfo.province||"未知"),1)])),_:1})])),_:1}),f(n,{class:"location-item"},{default:d((()=>[f(x,{class:"location-label"},{default:d((()=>[p("城市:")])),_:1}),f(x,{class:"location-value"},{default:d((()=>[p(_(t.locationInfo.city||"未知"),1)])),_:1})])),_:1})])),_:1})])),_:1})):h("",!0),t.locationInfo?h("",!0):(m(),r(n,{key:3,class:"location-fail"},{default:d((()=>[f(x,null,{default:d((()=>[p("检测到当前连接的网络为IPv6，因定位技术限制请连接IPv4的网络（公网IP地址）来显示当前所处位置的地图（不影响修改和保存您的用户信息）")])),_:1})])),_:1})),f(L,{"form-type":"submit",class:"save-btn"},{default:d((()=>[f(x,{class:"btn-text"},{default:d((()=>[p("保存修改")])),_:1})])),_:1}),f(n,{class:"logout-btn",onClick:o.handleLogout},{default:d((()=>[f(x,null,{default:d((()=>[p("退出登录")])),_:1})])),_:1},8,["onClick"])])),_:1},8,["onSubmit"])])),_:1})}],["__scopeId","data-v-c5cd524c"]]);export{F as default};
