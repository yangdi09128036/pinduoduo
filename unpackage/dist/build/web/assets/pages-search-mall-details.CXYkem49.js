import{l as s,W as t,s as o,n as e,m as a,b as n,z as i,a5 as l,r as c,c as d,w as r,i as u,o as f,d as g,e as h,q as p,u as _,F as I,t as m,f as y,x as w,j as v,g as k,a9 as b,h as C,aa as F}from"./index-CDX771vS.js";import{_ as M}from"./uni-icons.D1MAE8uI.js";import{r as P}from"./uni-app.es.i-bVV8oK.js";import{s as S}from"./store.Pgya9fdc.js";import{_ as x}from"./left.CpwphMH_.js";import{_ as T}from"./default-avatar.CrLKBTT2.js";import{_ as q,a as L}from"./wallet-red.Cfw-DLU5.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";const D=B({data:()=>({goodsInfo:{reviews:[]},countdownTime:"00:00:00",countdownSeconds:0,countdownInterval:null,countdownEndTime:0,isLoading:!0,showBuyPopup:!1,quantity:1,isFavorite:!1,successMessage:"",errorMessage:"",mapUrl:"",locationInfo:null,isLoadingMap:!1,key:"21bbea8854ce73ebd9163d7cf6cc9c76"}),async onLoad(s){this.isLoading=!0,this.initCountdown(),await this.loadGoodsInfo(s),await this.checkFavoriteStatus(),console.log("Initial userInfo:",S.userInfo),await this.addToHistory()},onShow(){s("paymentSuccess")&&(t("paymentSuccess"),o({title:"支付成功",icon:"success"}),this.hidePopup())},computed:{userInfo:()=>S.userInfo},methods:{async loadGoodsInfo(t){this.isLoading=!0;try{let o=null==t?void 0:t.id;if(!o){const t=s("currentProduct");t&&t._id&&(o=t._id)}if(o){const s=e.database(),t=await s.collection("mall-goods").doc(o).get();t&&(this.goodsInfo=Array.isArray(t.result.data)?t.result.data[0]:t.result.data,console.log("商品数据",this.goodsInfo),this.goodsInfo.reviews||(this.goodsInfo.reviews=[]),a("currentProduct",this.goodsInfo))}else console.error("无法获取商品ID")}catch(o){console.error("获取商品信息失败:",o)}finally{this.isLoading=!1}},initCountdown(){const t=s("countdownEndTime"),o=Math.floor(Date.now()/1e3);t&&t>o?(this.countdownEndTime=t,this.startCountdown()):this.createNewCountdown()},createNewCountdown(){const s=[5,10,15][Math.floor(3*Math.random())];this.countdownSeconds=60*s,this.countdownEndTime=Math.floor(Date.now()/1e3)+this.countdownSeconds,a("countdownEndTime",this.countdownEndTime),this.startCountdown()},startCountdown(){this.countdownInterval&&clearInterval(this.countdownInterval),this.updateCountdownDisplay(),this.countdownInterval=setInterval((()=>{this.updateCountdownDisplay()}),1e3)},updateCountdownDisplay(){const s=Math.floor(Date.now()/1e3),t=this.countdownEndTime-s;if(t<=0)this.countdownTime="00:00:00",clearInterval(this.countdownInterval),this.countdownInterval=null;else{const s=Math.floor(t/3600),o=Math.floor(t%3600/60),e=t%60;this.countdownTime=`${String(s).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(e).padStart(2,"0")}`}},goAllReviews(){this.goodsInfo.reviews.length>0?(a("currentProductReviews",this.goodsInfo.reviews),n({url:`/pages/search/AllReviews?id=${this.goodsInfo._id}`})):o({title:"本商品暂无评价",icon:"none"})},async checkFavoriteStatus(){if(!S.userInfo||!this.goodsInfo)return;const s=e.database().collection("favor"),t=await s.where({userId:S.userInfo._id,productId:this.goodsInfo._id}).get();this.isFavorite=t.result.data.length>0},async addToHistory(){if(!this.goodsInfo||!S.userInfo)return void console.warn("商品信息或用户信息为空，无法记录到历史浏览");const s=e.database().collection("history");try{0===(await s.where({userId:S.userInfo._id,productId:this.goodsInfo._id}).get()).result.data.length?(await s.add({userId:S.userInfo._id,productId:this.goodsInfo._id}),console.log("商品已记录到历史浏览")):console.log("商品已存在于历史浏览中")}catch(t){console.error("记录商品到历史浏览失败",t)}},async toggleFavorite(){S.userInfo&&this.goodsInfo?(this.isFavorite?await this.removeFromFavorites():await this.addToFavorites(),this.isFavorite=!this.isFavorite):o({title:"请先登录",icon:"none"})},async addToFavorites(){const s=e.database().collection("favor");try{await s.add({userId:S.userInfo._id,productId:this.goodsInfo._id}),this.successMessage="收藏成功",this.errorMessage="",o({title:this.successMessage,icon:"success"})}catch(t){this.errorMessage=t.message||"收藏失败，请检查网络",this.successMessage="",o({title:this.errorMessage,icon:"none"})}},async removeFromFavorites(){const s=e.database().collection("favor");try{await s.where({userId:S.userInfo._id,productId:this.goodsInfo._id}).remove(),this.successMessage="取消收藏成功",this.errorMessage="",o({title:this.successMessage,icon:"success"})}catch(t){this.errorMessage=t.message||"取消收藏失败，请检查网络",this.successMessage="",o({title:this.errorMessage,icon:"none"})}},maskPhone:s=>s?s.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"",showPopup(){this.showBuyPopup=!0,this.getLocationByIP()},hidePopup(){this.showBuyPopup=!1},increaseQuantity(){this.quantity++},decreaseQuantity(){this.quantity>1&&this.quantity--},async handlePayment(){if(!this.userInfo)return void o({title:"请先登录",icon:"none"});const s={amount:(this.goodsInfo.group_price||this.goodsInfo.price)*this.quantity,username:this.userInfo.username,mobile:this.userInfo.mobile,avatar:this.userInfo.avatar_file.url||"/static/avatar-default.png",productId:this.goodsInfo._id,productName:this.goodsInfo.name,productImage:this.goodsInfo.goods_thumb.fileID,quantity:this.quantity,userId:this.userInfo._id};console.log("支付数据",s),a("paymentData",s);const t=e.database().collection("order");try{const e=await t.add({userId:this.userInfo._id,productId:[this.goodsInfo._id],productName:this.goodsInfo.name,productImage:this.goodsInfo.goods_thumb.fileID,quantity:this.quantity,amount:s.amount,paymentStatus:0,shareStatus:0,shippingStatus:0,deliveryStatus:0,reviewStatus:0});e&&e.result&&e.result.id?(a("currentOrderIds",[e.result.id]),n({url:"/pages/wallet/pay"})):(console.error("订单创建成功，但未返回有效的 orderResult"),o({title:"创建订单失败，请重试",icon:"none"}))}catch(i){console.error("创建订单失败:",i),o({title:"创建订单失败，请重试",icon:"none"})}},convertToBannerArray:s=>"object"!=typeof s||null===s||Array.isArray(s)?s||[]:[s],navBack(){i()},goSet(){n({url:"/pages/user/set"})},async getLocationByIP(){this.isLoadingMap=!0;try{const s=await this.getIPLocation();console.log("定位信息:",s),this.locationInfo=s.data;let t=0,o=0;if(s.data.rectangle){const e=s.data.rectangle.split(";");if(e.length>0){const s=e[0].split(",");t=parseFloat(s[0]).toFixed(5),o=parseFloat(s[1]).toFixed(5);let a=parseFloat(t)+.43914,n=parseFloat(o)+.15293;this.mapUrl=`https://restapi.amap.com/v3/staticmap?location=${a},${n}&zoom=14&size=600*300&markers=mid,,A:${a},${n}&key=${this.key}`}}}catch(s){console.error("定位失败:",s)}finally{this.isLoadingMap=!1}},getIPLocation(){return new Promise(((s,t)=>{l({url:`https://restapi.amap.com/v3/ip?key=${this.key}`,success:o=>{"1"===o.data.status?s(o):t(new Error(o.data.info||"定位失败"))},fail:s=>{t(s)}})}))}}},[["render",function(s,t,o,e,a,n){const i=v,l=u,S=k,B=F,D=b,$=C,A=P(c("uni-icons"),M);return f(),d(l,{class:"container"},{default:r((()=>[a.isLoading?(f(),d(l,{key:0,class:"loading"},{default:r((()=>[g(i,null,{default:r((()=>[h("商品信息加载中...")])),_:1})])),_:1})):a.goodsInfo?(f(),d(l,{key:1},{default:r((()=>[g(l,{class:"back-icon-container"},{default:r((()=>[g(S,{class:"back-icon",src:x,onClick:n.navBack},null,8,["onClick"])])),_:1}),g(D,{class:"banner",circular:"","indicator-dots":!0,autoplay:!0,interval:"3000",duration:"1000"},{default:r((()=>[(f(!0),p(I,null,_(n.convertToBannerArray(a.goodsInfo.goods_banner_imgs),((s,t)=>(f(),d(B,{key:t},{default:r((()=>[g(S,{src:s.url,mode:"aspectFill",class:"banner-image"},null,8,["src"])])),_:2},1024)))),128))])),_:1}),g(l,{class:"price-marketing"},{default:r((()=>[g(l,{class:"price-section-container"},{default:r((()=>[g(l,{class:"price-section"},{default:r((()=>[g(i,{class:"currency"},{default:r((()=>[h("¥")])),_:1}),g(i,{class:"price"},{default:r((()=>[h(m(a.goodsInfo.price),1)])),_:1}),a.goodsInfo.is_on_sale?(f(),d(i,{key:0,class:"original-price"},{default:r((()=>[h("¥"+m((1.2*a.goodsInfo.price).toFixed(2)),1)])),_:1})):y("",!0)])),_:1}),g(l,{class:"promotion-tags"},{default:r((()=>[g(i,{class:"promotion-tag"},{default:r((()=>[h("30天低价")])),_:1}),g(i,{class:"promotion-text"},{default:r((()=>[h("全网低价")])),_:1}),g(i,{class:"promotion-text"},{default:r((()=>[h("全网疯抢30万件")])),_:1})])),_:1})])),_:1}),g(l,{class:"countdown-section"},{default:r((()=>[g(i,{class:"countdown-title"},{default:r((()=>[h("百亿补贴")])),_:1}),g(i,{class:"countdown-time"},{default:r((()=>[h(m(a.countdownTime),1)])),_:1}),g(i,{class:"countdown-title"},{default:r((()=>[h("即将恢复原价")])),_:1})])),_:1})])),_:1}),g(l,{class:"goods-info"},{default:r((()=>[g(l,{class:"title-section"},{default:r((()=>[g(i,{class:"brand-tag"},{default:r((()=>[h("品牌")])),_:1}),g(i,{class:"title"},{default:r((()=>[h(m(a.goodsInfo.name),1)])),_:1}),a.goodsInfo.is_hot||a.goodsInfo.is_new||a.goodsInfo.is_best?(f(),d(i,{key:0,class:"tags"},{default:r((()=>[a.goodsInfo.is_hot?(f(),d(i,{key:0,class:"tag"},{default:r((()=>[h("热销")])),_:1})):y("",!0),a.goodsInfo.is_new?(f(),d(i,{key:1,class:"tag"},{default:r((()=>[h("新品")])),_:1})):y("",!0),a.goodsInfo.is_best?(f(),d(i,{key:2,class:"tag"},{default:r((()=>[h("精品")])),_:1})):y("",!0)])),_:1})):y("",!0)])),_:1}),g(l,{class:"sales-stats"},{default:r((()=>[g(i,{class:"stat-item"},{default:r((()=>[h(m(a.goodsInfo.total_sell_count||"2068")+"人好评",1)])),_:1}),g(i,{class:"stat-item"},{default:r((()=>[h("24小时内200+人拼单")])),_:1}),g(i,{class:"stat-item"},{default:r((()=>[h("3466人收藏")])),_:1})])),_:1}),g(l,{class:"reviews-section"},{default:r((()=>[g(l,{class:"reviews-header"},{default:r((()=>[g(i,{class:"reviews-title"},{default:r((()=>[h("商品评价（"+m(a.goodsInfo&&a.goodsInfo.reviews?a.goodsInfo.reviews.length:0)+"）",1)])),_:1}),a.goodsInfo&&a.goodsInfo.reviews&&a.goodsInfo.reviews.length>0?(f(),d(i,{key:0,class:"reviews-view-all",onClick:n.goAllReviews},{default:r((()=>[h("查看全部>")])),_:1},8,["onClick"])):(f(),d(i,{key:1,class:"reviews-view-all",style:{color:"#999"}},{default:r((()=>[h("本商品为新品，期待您的购买评价")])),_:1}))])),_:1}),a.goodsInfo&&a.goodsInfo.reviews&&a.goodsInfo.reviews.length>0?(f(),d(l,{key:0,class:"reviews-list"},{default:r((()=>[(f(!0),p(I,null,_(a.goodsInfo.reviews.slice(0,2),((s,t)=>(f(),d(l,{class:"review-item",key:t},{default:r((()=>[g(l,{class:"review-avatar"},{default:r((()=>[g(S,{src:T,class:"avatar-image"})])),_:1}),g(l,{class:"review-content"},{default:r((()=>[g(l,{class:"review-user"},{default:r((()=>[h("匿名用户")])),_:1}),g(l,{class:"review-text"},{default:r((()=>[h(m(s),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):y("",!0)])),_:1}),g(l,{class:"image-gallery"},{default:r((()=>[(f(!0),p(I,null,_(n.convertToBannerArray(a.goodsInfo.goods_banner_imgs),((s,t)=>(f(),d(l,{class:"image-item",key:t},{default:r((()=>[g(S,{src:s.url,mode:"aspectFill",class:"gallery-image"},null,8,["src"])])),_:2},1024)))),128))])),_:1})])),_:1}),g(l,{class:"bottom-bar"},{default:r((()=>[g(l,{class:"action-buttons"},{default:r((()=>[g(l,{class:"action-item"},{default:r((()=>[g(i,{class:"action-icon"},{default:r((()=>[h("🏪")])),_:1}),g(i,{class:"action-text"},{default:r((()=>[h("店铺")])),_:1})])),_:1}),g(l,{class:"action-item",onClick:n.toggleFavorite},{default:r((()=>[g(i,{class:"action-icon"},{default:r((()=>[h(m(a.isFavorite?"❤️":"🤍"),1)])),_:1}),g(i,{class:"action-text"},{default:r((()=>[h("收藏")])),_:1})])),_:1},8,["onClick"]),g(l,{class:"action-item"},{default:r((()=>[g(i,{class:"action-icon"},{default:r((()=>[h("☎️")])),_:1}),g(i,{class:"action-text"},{default:r((()=>[h("客服")])),_:1})])),_:1})])),_:1}),g(l,{class:"buy-button"},{default:r((()=>[g($,{class:"group-buy",onClick:n.showPopup},{default:r((()=>[h("发起拼单")])),_:1},8,["onClick"])])),_:1})])),_:1}),a.showBuyPopup?(f(),d(l,{key:0,class:"popup-mask",onClick:n.hidePopup},null,8,["onClick"])):y("",!0),g(l,{class:w(["popup-content",{"popup-show":a.showBuyPopup}])},{default:r((()=>[g(l,{class:"close-btn",onClick:n.hidePopup},{default:r((()=>[h("×")])),_:1},8,["onClick"]),g(l,{class:"delivery-info"},{default:r((()=>[g(l,{class:"shipping-policy"},{default:r((()=>[g(A,{type:"checkbox-filled",color:"#67c23a",size:"16"}),g(i,{class:"policy-text"},{default:r((()=>[h("全场包邮 · 七天退换 · 48小时发货")])),_:1})])),_:1}),n.userInfo?(f(),d(l,{key:0,class:"address-info",onClick:n.goSet},{default:r((()=>[g(l,{class:"address-detail"},{default:r((()=>[g(S,{src:q,class:"address-icon"}),g(i,{class:"user-name"},{default:r((()=>[h(m(n.userInfo.username)+", ",1)])),_:1}),g(i,{class:"user-phone"},{default:r((()=>[h(m(n.maskPhone(n.userInfo.mobile))+", ",1)])),_:1}),g(i,{class:"user-address"},{default:r((()=>[h(m(n.userInfo.address),1)])),_:1})])),_:1}),g(A,{type:"right",size:"30",color:"#999"})])),_:1},8,["onClick"])):y("",!0),a.mapUrl?(f(),d(l,{key:1,class:"map-card"},{default:r((()=>[g(S,{src:a.mapUrl,mode:"widthFix",class:"map-image"},null,8,["src"]),g(l,{class:"location-info"},{default:r((()=>[g(i,{class:"location-header"},{default:r((()=>[g(i,{class:"location-title"},{default:r((()=>[h("当前位置:")])),_:1})])),_:1}),a.locationInfo?(f(),d(i,{key:0,class:"location-detail"},{default:r((()=>[g(i,{class:"location-text"},{default:r((()=>[h(m(a.locationInfo.province||"未知")+" "+m(a.locationInfo.city||"未知"),1)])),_:1})])),_:1})):y("",!0)])),_:1})])),_:1})):a.isLoadingMap?(f(),d(l,{key:2,class:"map-placeholder"},{default:r((()=>[g(i,{class:"placeholder-text"},{default:r((()=>[h("地图加载中...")])),_:1})])),_:1})):y("",!0)])),_:1}),g(l,{class:"product-info"},{default:r((()=>[g(S,{src:a.goodsInfo.goods_thumb.fileID,class:"product-image"},null,8,["src"]),g(l,{class:"product-details"},{default:r((()=>[g(l,{class:"group-price"},{default:r((()=>[g(i,{class:"price-label"},{default:r((()=>[h("多人团价")])),_:1}),g(i,{class:"price-symbol"},{default:r((()=>[h("¥")])),_:1}),g(i,{class:"price-value"},{default:r((()=>[h(m(a.goodsInfo.group_price||a.goodsInfo.price),1)])),_:1})])),_:1}),g(l,{class:"selected-info"},{default:r((()=>[g(i,null,{default:r((()=>[h("已选："+m(a.goodsInfo.name),1)])),_:1})])),_:1})])),_:1})])),_:1}),g(l,{class:"quantity-selector"},{default:r((()=>[g(i,null,{default:r((()=>[h("数量")])),_:1}),g(l,{class:"quantity-controls"},{default:r((()=>[g($,{class:"qty-btn",onClick:n.decreaseQuantity},{default:r((()=>[h("-")])),_:1},8,["onClick"]),g(i,{class:"qty-value"},{default:r((()=>[h(m(a.quantity),1)])),_:1}),g($,{class:"qty-btn",onClick:n.increaseQuantity},{default:r((()=>[h("+")])),_:1},8,["onClick"])])),_:1})])),_:1}),g(l,{class:"payment-method-section"},{default:r((()=>[g(i,null,{default:r((()=>[h("使用")])),_:1}),g(S,{src:L,class:"wallet-icon"}),g(i,null,{default:r((()=>[h("多多钱包支付")])),_:1})])),_:1}),g(l,{class:"payment-section"},{default:r((()=>[g($,{class:"payment-btn",onClick:n.handlePayment},{default:r((()=>[h(" 立即支付 ¥"+m((a.goodsInfo.group_price||a.goodsInfo.price)*a.quantity),1)])),_:1},8,["onClick"])])),_:1})])),_:1},8,["class"])])),_:1})):(f(),d(l,{key:2,class:"error"},{default:r((()=>[g(i,null,{default:r((()=>[h("加载商品信息失败，请重试")])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-595a5535"]]);export{D as default};
