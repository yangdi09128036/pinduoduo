import{s as t,n as a,z as e,r as l,c as o,w as s,i as n,o as c,d as r,e as i,t as u,q as d,u as f,F as h,g as p,j as _,h as g,I as m,x as w}from"./index-DyUMtph-.js";import{_ as b}from"./uni-popup.C65w3SNd.js";import{r as I}from"./uni-app.es.BWQr3qZr.js";import{s as y}from"./store.CDKRaDHf.js";import{_ as k}from"./left.CpwphMH_.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=v({data:()=>({walletInfo:{_id:"",balance:0,user_id:""},transactions:[],rechargeAmount:"",quickAmounts:[50,100,200,500,1e3,2e3]}),computed:{userInfo:()=>y.userInfo},onLoad(){this.loadWalletInfo()},onShow(){this.loadWalletInfo()},methods:{getTransactionImage:t=>(console.log("äº¤æ˜“è®°å½•",t),"credit"===t.type?"/static/recharge.png":"debit"===t.type&&t.productImage||"/static/wallet/payment.png"),async loadWalletInfo(){try{if(console.log("åŠ è½½é’±åŒ…ä¿¡æ¯",y.userInfo),!this.userInfo||!this.userInfo._id)return console.error("User info not available"),void t({title:"ç”¨æˆ·ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·å…ˆç™»å½•",icon:"none"});const e=a.database(),l=await e.collection("wallet").where({user_id:this.userInfo._id}).get();console.log("é’±åŒ…æŸ¥è¯¢ç»“æœ",l),l&&l.result&&l.result.data&&l.result.data.length>0?(this.walletInfo=l.result.data[0],console.log("è·å–åˆ°é’±åŒ…ä¿¡æ¯",this.walletInfo)):(console.log("æœªæ‰¾åˆ°é’±åŒ…ï¼Œåˆ›å»ºæ–°é’±åŒ…"),await this.createWallet()),await this.loadTransactions()}catch(e){console.error("åŠ è½½é’±åŒ…ä¿¡æ¯å¤±è´¥:",e),t({title:"åŠ è½½é’±åŒ…ä¿¡æ¯å¤±è´¥",icon:"none"})}},async createWallet(){try{const t=a.database(),e=await t.collection("wallet").where({user_id:this.userInfo._id}).get();if(e&&e.result&&e.result.data&&e.result.data.length>0)return this.walletInfo=e.result.data[0],void console.log("æ‰¾åˆ°å·²å­˜åœ¨çš„é’±åŒ…",this.walletInfo);const l=await t.collection("wallet").add({user_id:this.userInfo._id,balance:0});if(console.log("åˆ›å»ºé’±åŒ…ç»“æœ",l),!(l&&l.result&&l.result.id))throw new Error("åˆ›å»ºé’±åŒ…å¤±è´¥ï¼Œæœªè¿”å›æœ‰æ•ˆID");this.walletInfo={_id:l.result.id,user_id:this.userInfo._id,balance:0},console.log("æ–°é’±åŒ…ä¿¡æ¯",this.walletInfo)}catch(e){console.error("åˆ›å»ºé’±åŒ…å¤±è´¥:",e),t({title:"åˆ›å»ºé’±åŒ…å¤±è´¥",icon:"none"})}},async loadTransactions(){try{const t=a.database(),e=await t.collection("wallet_transactions").where({user_id:this.userInfo._id}).orderBy("created_at","desc").limit(10).get();e&&e.result&&e.result.data?(this.transactions=e.result.data,console.log("äº¤æ˜“è®°å½•åŠ è½½æˆåŠŸ:",this.transactions)):(console.log("æ²¡æœ‰äº¤æ˜“è®°å½•æˆ–ç»“æ„ä¸æ­£ç¡®",e),this.transactions=[])}catch(e){console.error("åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥:",e),t({title:"åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥",icon:"none"})}},async handleRecharge(){try{if(!this.walletInfo._id&&(console.log("é’±åŒ…ä¿¡æ¯ä¸å®Œæ•´ï¼Œé‡æ–°åŠ è½½"),await this.loadWalletInfo(),!this.walletInfo._id))return void t({title:"é’±åŒ…ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"});const e=parseFloat(this.rechargeAmount);if(isNaN(e)||e<=0)return void t({title:"è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢",icon:"none"});const l="number"==typeof this.walletInfo.balance?this.walletInfo.balance:0;if("number"!=typeof l)return console.error("é’±åŒ…ä½™é¢æ•°æ®ç±»å‹ä¸æ­£ç¡®"),void t({title:"å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"});const o=a.database();console.log("å……å€¼å‰çš„ä½™é¢",l);const s=l+e;console.log("å……å€¼åçš„ä½™é¢",s);const n=await o.collection("wallet").doc(this.walletInfo._id).update({balance:s,updated_at:Date.now()});if(console.log("æ›´æ–°ç»“æœ",n),!n||!n.result||!n.result.updated)return console.error("æ›´æ–°é’±åŒ…ä½™é¢å¤±è´¥",n),void t({title:"å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"});const c=await o.collection("wallet_transactions").add({user_id:this.userInfo._id,amount:e,type:"credit",balance:s});console.log("äº¤æ˜“è®°å½•åˆ›å»ºç»“æœ",c),this.walletInfo.balance=s,await this.loadTransactions(),t({title:"å……å€¼æˆåŠŸ",icon:"success"}),this.hideRechargePopup()}catch(e){console.error("å……å€¼å¤±è´¥:",e),t({title:"å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•",icon:"none"})}},formatBalance:t=>("number"==typeof t?t:0).toFixed(2),formatDate(t){if(!t)return"";const a=new Date(t);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}`},handleWithdraw(){t({title:"æç°åŠŸèƒ½æ­£åœ¨å¼€å‘",icon:"none"})},showRechargePopup(){this.$refs.rechargePopup.open()},hideRechargePopup(){this.$refs.rechargePopup.close(),this.rechargeAmount=""},selectQuickAmount(t){this.rechargeAmount=t.toString()},viewAllTransactions(){t({title:"æ­£åœ¨å¼€å‘ä¸­",icon:"none"})},navBack(){e()}}},[["render",function(t,a,e,y,v,A){const C=p,S=_,x=n,P=g,T=m,W=I(l("uni-popup"),b);return c(),o(x,{class:"wallet-container"},{default:s((()=>[r(x,{class:"nav-bar"},{default:s((()=>[r(x,{class:"nav-left",onClick:A.navBack},{default:s((()=>[r(C,{src:k,mode:"",class:"nav-icon"}),r(S,{class:"nav-title"},{default:s((()=>[i("ä½™é¢")])),_:1})])),_:1},8,["onClick"])])),_:1}),r(x,{class:"balance-card"},{default:s((()=>[r(x,{class:"security-tip"},{default:s((()=>[r(S,{class:"security-icon"},{default:s((()=>[i("ğŸ›¡ï¸")])),_:1}),r(S,{class:"security-text"},{default:s((()=>[i("èµ„é‡‘å®‰å…¨æœ‰ä¿éšœ")])),_:1}),r(S,{class:"security-arrow"},{default:s((()=>[i(">")])),_:1})])),_:1}),r(x,{class:"balance-section"},{default:s((()=>[r(S,null,{default:s((()=>[i("å¯ç”¨ä½™é¢(å…ƒ)")])),_:1}),r(S,{class:"balance-amount"},{default:s((()=>[i(u(A.formatBalance(v.walletInfo.balance)),1)])),_:1})])),_:1}),r(x,{class:"action-buttons"},{default:s((()=>[r(P,{class:"action-btn withdraw",onClick:A.handleWithdraw},{default:s((()=>[i("æç°")])),_:1},8,["onClick"]),r(P,{class:"action-btn recharge",onClick:A.showRechargePopup},{default:s((()=>[i("å……å€¼")])),_:1},8,["onClick"])])),_:1}),r(x,{class:"promo-banner"},{default:s((()=>[r(x,{class:"promo-icon"},{default:s((()=>[i("ğŸ”Š")])),_:1}),r(S,{class:"promo-text"},{default:s((()=>[i("ä½™é¢"+u(A.formatBalance(v.walletInfo.balance))+"å…ƒï¼Œæ¯å¤©æ”¯ä»˜äº«ç«‹å‡",1)])),_:1}),r(S,{class:"promo-link"},{default:s((()=>[i("å»çœ‹çœ‹")])),_:1})])),_:1})])),_:1}),r(x,{class:"transactions"},{default:s((()=>[r(x,{class:"transactions-header"},{default:s((()=>[r(S,{class:"header-title"},{default:s((()=>[i("ä½™é¢å˜åŠ¨æ˜ç»†")])),_:1}),r(S,{class:"header-link",onClick:A.viewAllTransactions},{default:s((()=>[i("å…¨éƒ¨ >")])),_:1},8,["onClick"])])),_:1}),r(x,{class:"transaction-list"},{default:s((()=>[(c(!0),d(h,null,f(v.transactions,((t,a)=>(c(),o(x,{class:"transaction-item",key:a},{default:s((()=>[r(x,{class:"transaction-icon"},{default:s((()=>[r(C,{src:A.getTransactionImage(t),class:"trans-icon"},null,8,["src"])])),_:2},1024),r(x,{class:"transaction-info"},{default:s((()=>[r(S,{class:"transaction-title"},{default:s((()=>[i(u("debit"===t.type?"æ‹¼å¤šå¤šè®¢å•æ”¯ä»˜":"å¤šå¤šé’±åŒ…ä½™é¢å……å€¼"),1)])),_:2},1024),r(x,null,{default:s((()=>[r(S,{class:"transaction-time"},{default:s((()=>[i(u(A.formatDate(t.created_at)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),r(x,{class:"transaction-amount"},{default:s((()=>[r(S,{class:w(["amount","debit"===t.type?"debit":"credit"])},{default:s((()=>[i(u("debit"===t.type?"-":"+")+u(t.amount.toFixed(2)),1)])),_:2},1032,["class"]),r(S,{class:"balance"},{default:s((()=>[i("ä½™é¢"+u(t.balance.toFixed(2))+"å…ƒ",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),r(W,{ref:"rechargePopup",type:"bottom"},{default:s((()=>[r(x,{class:"recharge-popup"},{default:s((()=>[r(x,{class:"popup-header"},{default:s((()=>[r(S,{class:"popup-title"},{default:s((()=>[i("å……å€¼é‡‘é¢")])),_:1}),r(S,{class:"popup-close",onClick:A.hideRechargePopup},{default:s((()=>[i("Ã—")])),_:1},8,["onClick"])])),_:1}),r(x,{class:"amount-input"},{default:s((()=>[r(S,{class:"currency-symbol"},{default:s((()=>[i("Â¥")])),_:1}),r(T,{type:"digit",modelValue:v.rechargeAmount,"onUpdate:modelValue":a[0]||(a[0]=t=>v.rechargeAmount=t),class:"amount-field",placeholder:"è¯·è¾“å…¥å……å€¼é‡‘é¢"},null,8,["modelValue"])])),_:1}),r(x,{class:"quick-amounts"},{default:s((()=>[(c(!0),d(h,null,f(v.quickAmounts,(t=>(c(),o(x,{class:w(["amount-option",{selected:v.rechargeAmount===t.toString()}]),key:t,onClick:a=>A.selectQuickAmount(t)},{default:s((()=>[i(" Â¥"+u(t),1)])),_:2},1032,["onClick","class"])))),128))])),_:1}),r(P,{class:"confirm-recharge",onClick:A.handleRecharge,disabled:!v.rechargeAmount||parseFloat(v.rechargeAmount)<=0},{default:s((()=>[i(" ç¡®è®¤å……å€¼ ")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-99a4486c"]]);export{A as default};
