import{n as a,s as e,z as s,E as l,b as t,B as o,C as i,a5 as n,c,w as r,i as d,o as u,d as f,e as m,ad as _,f as p,t as h,g as b,j as I,I as v,ab as g,h as y,ae as k}from"./index-CqNzDXlw.js";import{s as w}from"./store.DvWIVlV-.js";import{_ as U}from"./left.CpwphMH_.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const V=x({data:()=>({avatar_file:"",username:"",mobile:"",address:"",locationInfo:null,mapUrl:"",key:"21bbea8854ce73ebd9163d7cf6cc9c76"}),onLoad(){this.loadUserInfo(),this.getLocationByIP()},methods:{async loadUserInfo(){try{const e=await a.callFunction({name:"uni-id-cf",data:{action:"getCurrentUserInfo",params:{uid:w.userInfo._id,field:["username","mobile","address","avatar_file"]}}});if(0!==e.result.code)throw new Error(e.result.message||"获取用户信息失败");{const a=e.result.userInfo;console.log("用户信息",a),this.username=a.username||"",this.mobile=a.mobile||"",this.address=a.address||"",this.avatar_file=a.avatar_file||"",w.userInfo={...w.userInfo,...a}}}catch(s){console.error("获取用户信息失败:",s);const a=w.userInfo||{};this.username=a.username||"",this.mobile=a.mobile||"",this.address=a.address||"",this.avatar_file=a.avatar_file||"",e({title:"获取信息失败，使用缓存数据",icon:"none"})}},async saveUserInfo(){if(this.username&&this.mobile&&this.address)try{const l=a.database();await l.collection("uni-id-users").doc(w.userInfo._id).update({username:this.username,mobile:this.mobile,address:this.address}),w.userInfo={...w.userInfo,username:this.username,mobile:this.mobile,address:this.address,avatar_file:this.avatar_file},console.log("之后用户信息",w.userInfo),e({title:"保存成功",icon:"success"}),setTimeout((()=>{s()}),1500)}catch(l){console.error("保存用户信息失败:",l),e({title:"保存失败，请重试",icon:"none"})}else e({title:"请填写完整信息",icon:"none"})},handleBack(){s()},handleLogout(){l({title:"提示",content:"确定要退出登录吗？",success:a=>{a.confirm&&t({url:"/uni_modules/uni-id-pages/pages/login/login-withpwd"})}})},async getLocationByIP(){o({title:"定位中..."});try{const a=await this.getIPLocation();console.log("定位信息:",a),this.locationInfo=a.data;let e=0,s=0;if(a.data.rectangle){const l=a.data.rectangle.split(";");if(l.length>0){const a=l[0].split(",");e=parseFloat(a[0]).toFixed(5),s=parseFloat(a[1]).toFixed(5);let t=parseFloat(e)+.43914,o=parseFloat(s)+.15293;this.mapUrl=`https://restapi.amap.com/v3/staticmap?location=${t},${o}&zoom=14&size=600*300&markers=mid,,A:${t},${o}&key=${this.key}`}}}catch(a){console.error("定位失败:",a),this.locationInfo=null,e({title:"定位失败",icon:"none"})}finally{i()}},getIPLocation(){return new Promise(((a,e)=>{n({url:`https://restapi.amap.com/v3/ip?key=${this.key}`,success:s=>{"1"===s.data.status?a(s):e(new Error(s.data.info||"定位失败"))},fail:a=>{e(a)}})}))}}},[["render",function(a,e,s,l,t,o){const i=b,n=d,w=I,x=v,V=g,F=y,P=k;return u(),c(n,{class:"container"},{default:r((()=>[f(n,{class:"nav-bar"},{default:r((()=>[f(n,{class:"nav-back",onClick:o.handleBack},{default:r((()=>[f(i,{src:U,mode:"",class:"back-icon"})])),_:1},8,["onClick"]),f(w,{class:"page-title"},{default:r((()=>[m("个人信息")])),_:1})])),_:1}),f(P,{onSubmit:o.saveUserInfo},{default:r((()=>[f(n,{class:"form-card"},{default:r((()=>[f(n,{class:"form-item avatar_file-item"},{default:r((()=>[f(w,{class:"label"},{default:r((()=>[m("头像")])),_:1}),f(n,{class:"avatar_file-wrapper"},{default:r((()=>[_("img",{src:t.avatar_file.url,alt:""},null,8,["src"])])),_:1})])),_:1}),f(n,{class:"divider"}),f(n,{class:"form-item"},{default:r((()=>[f(w,{class:"label"},{default:r((()=>[m("用户名")])),_:1}),f(x,{class:"input",type:"text",modelValue:t.username,"onUpdate:modelValue":e[0]||(e[0]=a=>t.username=a),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),f(n,{class:"divider"}),f(n,{class:"form-item"},{default:r((()=>[f(w,{class:"label"},{default:r((()=>[m("手机号码")])),_:1}),f(x,{class:"input",type:"number",modelValue:t.mobile,"onUpdate:modelValue":e[1]||(e[1]=a=>t.mobile=a),placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),f(n,{class:"divider"}),f(n,{class:"form-item address-item"},{default:r((()=>[f(w,{class:"label"},{default:r((()=>[m("收货地址")])),_:1}),f(V,{class:"textarea",modelValue:t.address,"onUpdate:modelValue":e[2]||(e[2]=a=>t.address=a),placeholder:"请输入详细收货地址"},null,8,["modelValue"])])),_:1})])),_:1}),t.locationInfo?(u(),c(n,{key:0,class:"section-title"},{default:r((()=>[f(n,{class:"title-line"}),f(w,null,{default:r((()=>[m("位置信息")])),_:1}),f(n,{class:"title-line"})])),_:1})):p("",!0),t.locationInfo?(u(),c(n,{key:1,class:"map-card"},{default:r((()=>[t.mapUrl?(u(),c(i,{key:0,src:t.mapUrl,mode:"widthFix",class:"map-image"},null,8,["src"])):(u(),c(n,{key:1,class:"map-placeholder"},{default:r((()=>[f(w,{class:"placeholder-text"},{default:r((()=>[m("地图加载中...")])),_:1})])),_:1}))])),_:1})):p("",!0),t.locationInfo?(u(),c(n,{key:2,class:"location-info-card"},{default:r((()=>[f(n,{class:"location-header"},{default:r((()=>[f(w,{class:"location-title"},{default:r((()=>[m("您的大概位置")])),_:1})])),_:1}),f(n,{class:"location-detail"},{default:r((()=>[f(n,{class:"location-item"},{default:r((()=>[f(w,{class:"location-label"},{default:r((()=>[m("省份:")])),_:1}),f(w,{class:"location-value"},{default:r((()=>[m(h(t.locationInfo.province||"未知"),1)])),_:1})])),_:1}),f(n,{class:"location-item"},{default:r((()=>[f(w,{class:"location-label"},{default:r((()=>[m("城市:")])),_:1}),f(w,{class:"location-value"},{default:r((()=>[m(h(t.locationInfo.city||"未知"),1)])),_:1})])),_:1})])),_:1})])),_:1})):p("",!0),t.locationInfo?p("",!0):(u(),c(n,{key:3,class:"location-fail"},{default:r((()=>[f(w,null,{default:r((()=>[m("检测到当前连接的网络为IPv6，因定位技术限制请连接IPv4的网络（公网IP地址）来显示当前所处位置的地图（不影响修改和保存您的用户信息）")])),_:1})])),_:1})),f(F,{"form-type":"submit",class:"save-btn"},{default:r((()=>[f(w,{class:"btn-text"},{default:r((()=>[m("保存修改")])),_:1})])),_:1}),f(n,{class:"logout-btn",onClick:o.handleLogout},{default:r((()=>[f(w,null,{default:r((()=>[m("退出登录")])),_:1})])),_:1},8,["onClick"])])),_:1},8,["onSubmit"])])),_:1})}],["__scopeId","data-v-39e72653"]]);export{V as default};
